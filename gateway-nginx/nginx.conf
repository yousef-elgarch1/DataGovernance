events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # ═══════════════════════════════════════════════════════
    # UPSTREAM DEFINITIONS - All 9 Microservices
    # ═══════════════════════════════════════════════════════
    
    upstream auth_api {
        server auth-service:8001;
    }
    
    upstream taxonomie_api {
        server taxonomie-service:8002;
    }
    
    upstream presidio_api {
        server presidio-service:8003;
    }
    
    upstream cleaning_api {
        server cleaning-service:8004;
    }
    
    upstream classification_api {
        server classification-service:8005;
    }
    
    upstream correction_api {
        server correction-service:8006;
    }
    
    upstream annotation_api {
        server annotation-service:8007;
    }
    
    upstream quality_api {
        server quality-service:8008;
    }
    
    upstream ethimask_api {
        server ethimask-service:8009;
    }

    # ═══════════════════════════════════════════════════════
    # MAIN SERVER - Port 8000
    # ═══════════════════════════════════════════════════════
    server {
        listen 8000;
        server_name localhost;

        # ─────────────────────────────────────────────
        # FRONTEND - Static Files (Dashboard)
        # ─────────────────────────────────────────────
        location / {
            root /usr/share/nginx/html;
            index index.html login.html;
            try_files $uri $uri/ /index.html;
        }

        # ─────────────────────────────────────────────
        # API: Authentication Service
        # /api/auth/* → auth-service:8001
        # ─────────────────────────────────────────────
        location /api/auth/ {
            proxy_pass http://auth_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Also support /auth/* for frontend compatibility
        location /auth/ {
            proxy_pass http://auth_api/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # API: Users Service (Registration/Management)
        # /api/users/* → auth-service:8001
        # ─────────────────────────────────────────────
        location /api/users/ {
            proxy_pass http://auth_api/users/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # API: Taxonomie Service (PII/SPI Patterns)
        # /api/taxonomie/* → taxonomie-service:8002
        # ─────────────────────────────────────────────
        location /api/taxonomie/ {
            proxy_pass http://taxonomie_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # API: Presidio Service (Microsoft Presidio)
        # /api/presidio/* → presidio-service:8003
        # ─────────────────────────────────────────────
        location /api/presidio/ {
            proxy_pass http://presidio_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # API: Cleaning Service (Data Profiling)
        # /api/cleaning/* → cleaning-service:8004
        # ─────────────────────────────────────────────
        location /api/cleaning/ {
            proxy_pass http://cleaning_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # API: Classification Service (ML/NLP)
        # /api/classification/* → classification-service:8005
        # ─────────────────────────────────────────────
        location /api/classification/ {
            proxy_pass http://classification_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # API: Correction Service (Auto-fix)
        # /api/correction/* → correction-service:8006
        # ─────────────────────────────────────────────
        location /api/correction/ {
            proxy_pass http://correction_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # API: Annotation Service (Human Validation)
        # /api/annotation/* → annotation-service:8007
        # ─────────────────────────────────────────────
        location /api/annotation/ {
            proxy_pass http://annotation_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # API: Quality Service (ISO 25012 Metrics)
        # /api/quality/* → quality-service:8008
        # ─────────────────────────────────────────────
        location /api/quality/ {
            proxy_pass http://quality_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # API: EthiMask Service (Contextual Masking)
        # /api/ethimask/* → ethimask-service:8009
        # ─────────────────────────────────────────────
        location /api/ethimask/ {
            proxy_pass http://ethimask_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ─────────────────────────────────────────────
        # Health Check Endpoint
        # ─────────────────────────────────────────────
        location /health {
            return 200 'DataGov Gateway OK';
            add_header Content-Type text/plain;
        }
    }
}
