<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataSentinel - Intelligent Data Governance</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Dashboard specific styles */
        .tabs button.active {
            color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }
        .view-container {
            display: none;
            min-height: calc(100vh - 200px);
        }
        .view-container.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            transition: all var(--transition-fast);
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .stat-icon.purple {
            background: rgba(139, 92, 246, 0.15);
        }

        .stat-icon.blue {
            background: rgba(59, 130, 246, 0.15);
        }

        .stat-icon.green {
            background: rgba(16, 185, 129, 0.15);
        }

        .stat-icon.orange {
            background: rgba(245, 158, 11, 0.15);
        }

        .stat-info h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .stat-info p {
            font-size: 0.875rem;
            color: var(--text-tertiary);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-xl);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }

        .feature-card {
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .feature-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(99, 102, 241, 0.1);
        }

        .feature-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: var(--space-md);
            background: var(--accent-gradient);
        }

        .feature-card h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .feature-card p {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        .service-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .service-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .service-item:hover {
            background: var(--bg-card-hover);
        }

        .service-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: rgba(99, 102, 241, 0.1);
        }

        .service-info {
            flex: 1;
        }

        .service-info h5 {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .service-info span {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .activity-list {
            display: flex;
            flex-direction: column;
        }

        .activity-item {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--border-secondary);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            margin-top: 6px;
            flex-shrink: 0;
        }

        .activity-content h5 {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .activity-content span {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Upload Zone */
        .upload-section {
            margin-top: var(--space-xl);
        }

        .upload-zone {
            border: 2px dashed var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--bg-card);
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
        }

        .upload-zone h4 {
            margin-bottom: var(--space-xs);
        }

        .upload-zone p {
            color: var(--text-tertiary);
            font-size: 0.875rem;
        }

        /* View System */
        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Quality View */
        .quality-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .quality-card {
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
        }

        .quality-score {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .quality-label {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            margin-top: var(--space-xs);
        }

        .quality-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            margin-top: var(--space-md);
            overflow: hidden;
        }

        .quality-bar-fill {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }

        /* Data Preview Table */
        .data-preview {
            overflow-x: auto;
            margin-top: var(--space-lg);
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .data-preview th {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-secondary);
            text-align: left;
            white-space: nowrap;
        }

        .data-preview td {
            padding: var(--space-sm) var(--space-md);
            border-bottom: 1px solid var(--border-secondary);
        }

        /* Masking Preview */
        .masking-preview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-lg);
        }

        .mask-card {
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }

        .mask-card h4 {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .mask-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm) 0;
            border-bottom: 1px dashed var(--border-secondary);
        }

        .mask-original {
            color: var(--text-tertiary);
            text-decoration: line-through;
        }

        .mask-hidden {
            font-family: var(--font-mono);
            color: var(--success);
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .quality-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .feature-grid {
                grid-template-columns: 1fr;
            }

            .masking-preview {
                grid-template-columns: 1fr;
            }
        }

        /* Hamburger Menu Button */
        .hamburger-btn {
            display: flex;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-md);
            width: 40px;
            height: 40px;
            cursor: pointer;
            color: var(--text-primary);
            align-items: center;
            justify-content: center;
        }

        .hamburger-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Sidebar Toggle States - works on all screens */
        .sidebar {
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }
        
        /* Adjust main content when sidebar collapsed */
        .main-content.expanded {
            margin-left: 0;
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                height: 100vh;
                z-index: 1000;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <!-- Overlay for mobile sidebar -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-icon" style="width: 40px; height: 40px; margin-right: 12px; flex-shrink: 0;">
                        <img src="logo.svg" alt="DataSentinel Logo" style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <div style="display: flex; flex-direction: column; justify-content: center;">
                        <span style="font-weight: 800; font-size: 1.25rem; letter-spacing: -0.5px; color: var(--text-primary);">DataSentinel</span>
                        <span style="font-size: 0.65rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600;">Admin Console</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" data-view="dashboard">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                    <a class="nav-item" data-view="upload">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span>Upload Data</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Data Pipeline</div>
                    <a class="nav-item" data-view="cleaning" data-roles="admin,steward,annotator">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                            </path>
                        </svg>
                        <span>Data Cleaning</span>
                    </a>
                    <a class="nav-item" data-view="quality" data-roles="admin,steward">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <span>Quality Metrics</span>
                        <span class="badge badge-success">ISO</span>
                    </a>
                    <a class="nav-item" data-view="pii">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <span>PII Detection</span>
                    </a>
                    <a class="nav-item" data-view="masking" data-roles="admin,steward">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <span>EthiMask</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Workflow</div>
                    <a class="nav-item" data-view="tasks">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        <span>Annotation Tasks</span>
                        <span class="badge badge-primary" id="taskCount">0</span>
                    </a>
                    <a class="nav-item" data-view="corrections" data-roles="admin,steward,annotator">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        <span>Corrections</span>
                    </a>
                    <a class="nav-item" data-view="user-stats">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                            <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                        </svg>
                        <span>My Statistics</span>
                        <span class="badge badge-success">Personal</span>
                    </a>
                </div>

                <div class="nav-section" data-section-roles="admin">
                    <div class="nav-section-title">Administration</div>
                    <a class="nav-item" data-view="users" data-roles="admin">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>User Management</span>
                    </a>
                    <a class="nav-item" data-view="ethimask-config" data-roles="admin">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                        <span>EthiMask Config</span>
                    </a>
                </div>

                <div class="nav-section" data-section-roles="admin,steward,annotator">
                    <div class="nav-section-title">Governance</div>
                    <a class="nav-item" data-view="taxonomy" data-roles="admin,steward">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                        <span>Taxonomy Manager</span>
                    </a>
                    <a class="nav-item" data-view="approvals" data-roles="admin,steward">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="9 11 12 14 22 4"></polyline>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        <span>Approval Queue</span>
                    </a>
                    <a class="nav-item" data-view="classification-validation" data-roles="admin,steward,annotator">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                        </svg>
                        <span>Classification Validation</span>
                    </a>
                    <a class="nav-item" data-view="false-positives" data-roles="admin,steward,annotator">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        <span>False Positives</span>
                    </a>
                    <a class="nav-item" data-view="correction-rules" data-roles="admin,steward">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        <span>Correction Rules</span>
                    </a>

                    <a class="nav-item" data-view="audit-logs" data-roles="admin">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        <span>Audit Logs</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="nav-section-title" style="padding: 0 1rem; margin-bottom: 0.5rem; font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Account</div>
                <div class="nav-item" onclick="safeLogout()">
                    <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Logout</span>
                </div>
            </div>
        </aside>

        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <!-- Hamburger Menu for Mobile -->
                    <button class="hamburger-btn" onclick="toggleSidebar()" title="Toggle Menu">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div class="header-search">
                        <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" class="form-input" placeholder="Search datasets, tasks...">
                    </div>
                </div>

                <div class="header-right">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                        <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                        </svg>
                    </button>
                    <button class="btn-icon btn-ghost" title="Notifications">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </button>
                    <div class="user-avatar" id="userAvatar">U</div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Dashboard View -->
                <div class="view-container active" id="view-dashboard">
                    <div class="page-header">
                        <h1 class="page-title">Welcome back, <span id="userName">User</span> <span id="userRoleBadge"
                                class="badge badge-primary" style="font-size: 0.75rem; vertical-align: middle;"></span>
                        </h1>
                        <p class="page-subtitle">Here's what's happening with your data governance pipeline</p>
                    </div>

                    <!-- Stats -->
                    <div class="stats-grid stagger">
                        <div class="stat-card animate-slide-up">
                            <div class="stat-icon purple"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <path d="M21 21H3V3" />
                                    <path d="M18 9l-5 5-4-4-5 5" />
                                </svg></div>
                            <div class="stat-info">
                                <h3 id="statDatasets">0</h3>
                                <p>Datasets Processed</p>
                            </div>
                        </div>
                        <div class="stat-card animate-slide-up">
                            <div class="stat-icon blue"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8" />
                                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                                </svg></div>
                            <div class="stat-info">
                                <h3 id="statPII">0</h3>
                                <p>PII Entities Found</p>
                            </div>
                        </div>
                        <div class="stat-card animate-slide-up">
                            <div class="stat-icon green"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                    <polyline points="22 4 12 14.01 9 11.01" />
                                </svg></div>
                            <div class="stat-info">
                                <h3 id="statQuality">--</h3>
                                <p>Avg Quality Score</p>
                            </div>
                        </div>
                        <div class="stat-card animate-slide-up">
                            <div class="stat-icon orange"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <path
                                        d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
                                </svg></div>
                            <div class="stat-info">
                                <h3 id="statTasks">0</h3>
                                <p>Pending Tasks</p>
                            </div>
                        </div>
                    </div>

                    <div class="main-grid">
                        <!-- Features -->
                        <div>
                            <h3 style="margin-bottom: var(--space-lg);">Quick Actions</h3>
                            <div class="feature-grid">
                                <div class="feature-card" onclick="navigateTo('upload')" id="action-upload">
                                    <div class="feature-icon"><svg width="28" height="28" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                            <polyline points="17 8 12 3 7 8" />
                                            <line x1="12" y1="3" x2="12" y2="15" />
                                        </svg></div>
                                    <h4>Upload Dataset</h4>
                                    <p>Import CSV, Excel, or JSON files for processing</p>
                                </div>
                                <div class="feature-card" onclick="navigateTo('cleaning')" id="action-cleaning">
                                    <div class="feature-icon"><svg width="28" height="28" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34" />
                                            <polygon points="18 2 22 6 12 16 8 16 8 12 18 2" />
                                        </svg></div>
                                    <h4>Clean Data</h4>
                                    <p>Remove duplicates, handle missing values, fix outliers</p>
                                </div>
                                <div class="feature-card" onclick="navigateTo('quality')" id="action-quality">
                                    <div class="feature-icon"><svg width="28" height="28" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="20" x2="18" y2="10" />
                                            <line x1="12" y1="20" x2="12" y2="4" />
                                            <line x1="6" y1="20" x2="6" y2="14" />
                                        </svg></div>
                                    <h4>Quality Analysis</h4>
                                    <p>ISO 25012 metrics with detailed reports</p>
                                </div>
                                <div class="feature-card" onclick="navigateTo('pii')" id="action-pii">
                                    <div class="feature-icon"><svg width="28" height="28" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                                        </svg></div>
                                    <h4>PII Detection</h4>
                                    <p>Moroccan-aware sensitive data detection</p>
                                </div>
                            </div>
                        </div>

                        <!-- Service Status -->
                        <div>
                            <div class="card" style="margin-bottom: var(--space-lg);">
                                <div class="card-header">
                                    <h4 class="card-title">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                        </svg>
                                        Service Status
                                    </h4>
                                </div>
                                <div class="service-list" id="serviceList">
                                    <!-- Populated by JS -->
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">Recent Activity</h4>
                                </div>
                                <div class="activity-list">
                                    <div class="activity-item">
                                        <div class="activity-dot"></div>
                                        <div class="activity-content">
                                            <h5>Dataset uploaded</h5>
                                            <span>customers_2024.csv â€¢ Just now</span>
                                        </div>
                                    </div>
                                    <div class="activity-item">
                                        <div class="activity-dot" style="background: var(--success)"></div>
                                        <div class="activity-content">
                                            <h5>Quality check passed</h5>
                                            <span>Score: 87% â€¢ 2 min ago</span>
                                        </div>
                                    </div>
                                    <div class="activity-item">
                                        <div class="activity-dot" style="background: var(--warning)"></div>
                                        <div class="activity-content">
                                            <h5>PII detected</h5>
                                            <span>15 entities â€¢ 5 min ago</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload View -->
                <div class="view-container" id="view-upload">
                    <div class="page-header">
                        <h1 class="page-title">Upload Dataset</h1>
                        <p class="page-subtitle">Import your data for processing and analysis</p>
                    </div>

                    <div class="card">
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="1.5">
                                    <path
                                        d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                                </svg></div>
                            <h4>Drop your file here or click to browse</h4>
                            <p>Supports CSV, Excel (.xlsx), and JSON files up to 50MB</p>
                        </div>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json" style="display: none;">

                        <div id="uploadProgress" style="display: none; margin-top: var(--space-lg);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-sm);">
                                <span id="uploadFileName">file.csv</span>
                                <span id="uploadPercent">0%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="uploadBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div id="uploadResult" style="display: none; margin-top: var(--space-xl);">
                            <div
                                style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-lg);">
                                <div style="font-size: 2rem;"><svg width="32" height="32" viewBox="0 0 24 24"
                                        fill="none" stroke="var(--success)" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                        <polyline points="22 4 12 14.01 9 11.01" />
                                    </svg></div>
                                <div>
                                    <h4>Upload Successful!</h4>
                                    <p style="color: var(--text-tertiary);">Dataset ID: <code id="datasetId">--</code>
                                    </p>
                                </div>
                            </div>
                            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                                <div class="stat-card">
                                    <div class="stat-info" style="text-align: center;">
                                        <h3 id="resultRows">0</h3>
                                        <p>Rows</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-info" style="text-align: center;">
                                        <h3 id="resultCols">0</h3>
                                        <p>Columns</p>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-info" style="text-align: center;">
                                        <h3 style="color: var(--success);">Ready</h3>
                                        <p>Status</p>
                                    </div>
                                </div>
                            </div>
                            <div id="uploadPreviewContainer" style="margin-top: var(--space-lg); overflow-x: auto;">
                                <!-- Preview Table Will Be Injected Here -->
                            </div>
                            <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-md);">
                                <button class="btn btn-primary" onclick="navigateTo('cleaning')">Clean Data</button>
                                <button class="btn btn-secondary" onclick="navigateTo('quality')">Check Quality</button>
                                <button class="btn btn-secondary" onclick="navigateTo('pii')">Detect PII</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cleaning View -->
            <div class="view-container" id="view-cleaning">
                <div class="page-header">
                    <h1 class="page-title">Data Cleaning</h1>
                    <p class="page-subtitle">Clean and transform your dataset</p>
                </div>

                <div class="main-grid">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Cleaning Options</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="cleanDuplicates" checked>
                                    <span>Remove duplicate rows</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Handle Missing Values</label>
                                <select class="form-input" id="cleanMissing">
                                    <option value="mean">Fill with mean (numeric)</option>
                                    <option value="median">Fill with median</option>
                                    <option value="mode">Fill with mode</option>
                                    <option value="drop">Drop rows with missing</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="cleanOutliers">
                                    <span>Remove outliers (IQR method)</span>
                                </label>
                            </div>
                            <button class="btn btn-primary btn-lg" style="width: 100%; margin-top: var(--space-md);"
                                onclick="runCleaning()">
                                Run Cleaning
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Cleaning Results</h4>
                        </div>
                        <div id="cleaningResults">
                            <p style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl);">
                                Upload a dataset and run cleaning to see results
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quality View -->
            <div class="view-container" id="view-quality">
                <div class="page-header">
                    <h1 class="page-title">Quality Analysis</h1>
                    <p class="page-subtitle">ISO 25012 Data Quality Metrics</p>
                </div>

                <!-- NEW: Methodology Section -->
                <div class="card" style="margin-bottom: var(--space-lg); border-left: 4px solid var(--accent-primary);">
                    <div class="card-header" style="cursor: pointer;" onclick="document.getElementById('isoDetails').style.display = document.getElementById('isoDetails').style.display === 'none' ? 'block' : 'none'">
                        <h4 class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                            ðŸ“Š Methodology: ISO 25012 Data Quality Model
                            <span style="font-size: 0.8rem; opacity: 0.7;">(Click to Toggle)</span>
                        </h4>
                    </div>
                    <div id="isoDetails" style="display: none; padding-top: var(--space-md);">
                        <div class="feature-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;"><strong>Completeness:</strong> % of non-null values.</div>
                            <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;"><strong>Accuracy:</strong> Syntax & type validity (e.g., numeric ranges).</div>
                            <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;"><strong>Consistency:</strong> Contradiction checks within data.</div>
                            <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;"><strong>Uniqueness:</strong> Rate of unique records (no duplicates).</div>
                            <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;"><strong>Validity:</strong> Compliance with business formats.</div>
                            <div style="padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;"><strong>Timeliness:</strong> Data freshness and age.</div>
                        </div>
                    </div>
                </div>

                <div class="quality-grid" id="qualityGrid">
                    <div class="quality-card">
                        <div class="quality-score" id="scoreCompleteness">--</div>
                        <div class="quality-label">Completeness</div>
                        <div class="quality-bar">
                            <div class="quality-bar-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="quality-card">
                        <div class="quality-score" id="scoreAccuracy">--</div>
                        <div class="quality-label">Accuracy</div>
                        <div class="quality-bar">
                            <div class="quality-bar-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="quality-card">
                        <div class="quality-score" id="scoreConsistency">--</div>
                        <div class="quality-label">Consistency</div>
                        <div class="quality-bar">
                            <div class="quality-bar-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="quality-card">
                        <div class="quality-score" id="scoreUniqueness">--</div>
                        <div class="quality-label">Uniqueness</div>
                        <div class="quality-bar">
                            <div class="quality-bar-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="quality-card">
                        <div class="quality-score" id="scoreValidity">--</div>
                        <div class="quality-label">Validity</div>
                        <div class="quality-bar">
                            <div class="quality-bar-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="quality-card">
                        <div class="quality-score" id="scoreTimeliness">--</div>
                        <div class="quality-label">Timeliness</div>
                        <div class="quality-bar">
                            <div class="quality-bar-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="text-align: center; padding: var(--space-xl);">
                        <div style="max-width: 400px; margin: 0 auto 1.5rem auto;">
                            <label class="form-label" style="text-align: left;">Select Dataset to Analyze</label>
                            <select class="form-input" id="qualityDatasetSelect">
                                <option value="">-- Choose Dataset --</option>
                                <option value="current">Current Uploaded File</option>
                                <option value="demo_customers">customers_2024.csv (Demo)</option>
                                <option value="demo_transactions">transactions_q4.csv (Demo)</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-primary btn-lg" onclick="runQualityCheck()">Run Quality Analysis</button>
                            <button class="btn btn-secondary btn-lg" onclick="generateQualityReport()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                                Generate PDF Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PII View -->
            <div class="view-container" id="view-pii">
                <div class="page-header">
                    <h1 class="page-title">PII Detection</h1>
                    <p class="page-subtitle">Detect sensitive personal information with Moroccan patterns</p>
                </div>

                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="tabs" style="display: flex; gap: var(--space-md); margin-bottom: var(--space-md); border-bottom: 1px solid var(--border-secondary); padding-bottom: var(--space-sm);">
                        <button class="btn btn-ghost active" id="tabPiiText" onclick="switchPiiTab('text')">Text Input</button>
                        <button class="btn btn-ghost" id="tabPiiDataset" onclick="switchPiiTab('dataset')">Current Dataset</button>
                    </div>

                    <div id="piiTextInput">
                        <div class="form-group">
                            <label class="form-label">Enter text to analyze</label>
                            <textarea class="form-input" id="piiText" rows="4"
                                placeholder="Paste text containing potential PII (e.g., CIN: AB123456, Tel: 0612345678)"></textarea>
                        </div>
                    </div>

                    <div id="piiDatasetInput" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Analyze Uploaded File</label>
                            <p id="piiDatasetName" style="color: var(--text-secondary); margin-bottom: var(--space-md);">No dataset uploaded.</p>
                            <div class="alert alert-info" style="font-size: 0.875rem;">
                                <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: text-bottom;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                                Analyzes a sample of your dataset for PII columns.
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" style="margin-top: var(--space-md);" onclick="detectPII()">
                        <span id="piiBtnText">Detect PII in Text</span>
                    </button>
                </div>

                <div class="card" id="piiResults" style="display: none;">
                    <div class="card-header">
                        <h4 class="card-title">Detection Results</h4>
                    </div>
                    <div id="piiResultsList"></div>
                </div>
            </div>

            <!-- Masking View -->
            <div class="view-container" id="view-masking">
                <div class="page-header">
                    <h1 class="page-title">EthiMask - Contextual Masking</h1>
                    <p class="page-subtitle">Role-based data masking preview</p>
                </div>

                <div style="display: flex; gap: 2rem; margin-bottom: var(--space-xl); align-items: flex-end;">
                    <div class="form-group" style="flex: 1; max-width: 400px;">
                        <label class="form-label">Select Dataset for Masking Preview</label>
                        <select class="form-input" id="maskDatasetSelect" onchange="updateMaskPreview()">
                            <option value="">-- Choose Dataset --</option>
                            <option value="current">Current Uploaded File</option>
                            <option value="demo">Demo Data (Dr. RealData)</option>
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; max-width: 300px;">
                        <label class="form-label">Select Role to Preview</label>
                        <select class="form-input" id="maskRole" onchange="updateMaskPreview()">
                            <option value="admin">Admin (Full Access)</option>
                            <option value="steward">Data Steward</option>
                            <option value="annotator">Annotator</option>
                            <option value="labeler" selected>Labeler</option>
                            <option value="external">External</option>
                        </select>
                    </div>
                </div>

                <div class="masking-preview">
                    <div class="mask-card">
                        <h4>Personal Information</h4>
                        <div class="mask-item">
                            <span>Name</span>
                            <span class="mask-hidden" id="maskName">Mohammed A.</span>
                        </div>
                        <div class="mask-item">
                            <span>CIN</span>
                            <span class="mask-hidden" id="maskCIN">AB******56</span>
                        </div>
                        <div class="mask-item">
                            <span>Phone</span>
                            <span class="mask-hidden" id="maskPhone">+212 6** *** ***</span>
                        </div>
                    </div>
                    <div class="mask-card">
                        <h4>ðŸ’¼ Financial Data</h4>
                        <div class="mask-item">
                            <span>IBAN</span>
                            <span class="mask-hidden" id="maskIBAN">MA64****...****1234</span>
                        </div>
                        <div class="mask-item">
                            <span>Salary</span>
                            <span class="mask-hidden" id="maskSalary">10K-20K MAD</span>
                        </div>
                        <div class="mask-item">
                            <span>CNSS</span>
                            <span class="mask-hidden" id="maskCNSS">***456***</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks View -->
            <div class="view-container" id="view-tasks">
                <div class="page-header">
                    <h1 class="page-title">Annotation Tasks</h1>
                    <p class="page-subtitle">Human validation workflow - Review and label PII detections</p>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: var(--space-lg);">
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myPendingTasks">0</h3>
                            <p>My Pending</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myCompletedTasks">0</h3>
                            <p>Completed Today</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="avgTaskTime">--</h3>
                            <p>Avg Time (s)</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myQualityScore">--</h3>
                            <p>Quality Score</p>
                        </div>
                    </div>
                </div>

                <div class="main-grid">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">My Task Queue</h4>
                        </div>
                        <div id="taskQueueList">
                            <div class="task-item"
                                style="padding: var(--space-md); border-bottom: 1px solid var(--border-primary);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span class="badge badge-primary">PII Validation</span>
                                        <span style="margin-left: var(--space-sm);">Dataset: customers_2024.csv</span>
                                    </div>
                                    <div style="display: flex; gap: var(--space-sm);">
                                        <button class="btn btn-primary" style="padding: 0.25rem 0.75rem;"
                                            onclick="startTask('task-001')">Start</button>
                                    </div>
                                </div>
                                <p
                                    style="color: var(--text-tertiary); margin-top: var(--space-xs); font-size: 0.875rem;">
                                    5 detections need validation | Assigned 2 min ago
                                </p>
                            </div>
                            <p id="noTasksMessage"
                                style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl); display: none;">
                                No pending tasks assigned to you.
                            </p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Active Task</h4>
                        </div>
                        <div id="activeTaskArea">
                            <p style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl);">
                                Select a task from your queue to start validation.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Corrections View -->
            <div class="view-container" id="view-corrections">
                <div class="page-header">
                    <h1 class="page-title">Data Corrections</h1>
                    <p class="page-subtitle">Review and approve automated corrections</p>
                </div>

                <div class="card">
                    <p style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl);">
                        No corrections pending. Run data cleaning to generate correction suggestions.
                    </p>
                </div>
            </div>

            <!-- User Statistics View -->
            <div class="view-container" id="view-user-stats">
                <div class="page-header">
                    <h1 class="page-title">My Statistics</h1>
                    <p class="page-subtitle">Your performance metrics and contribution overview</p>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: var(--space-lg);">
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myTasksCompleted">0</h3>
                            <p>Tasks Completed</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myAccuracy">0%</h3>
                            <p>Accuracy</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myAvgTime">0s</h3>
                            <p>Avg Time</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myKappaScore">0.00</h3>
                            <p>Kappa Score</p>
                        </div>
                    </div>
                </div>

                <div class="main-grid">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Performance Trends</h4>
                        </div>
                        <div style="height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-tertiary);">
                            Chart visualization coming soon
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Quality Targets</h4>
                        </div>
                        <div class="service-list">
                            <div class="service-item">
                                <div class="service-info">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                        <h5>Accuracy Target</h5>
                                        <span>> 90%</span>
                                    </div>
                                    <div class="quality-bar" style="margin-top:0;"><div class="quality-bar-fill" id="accuracyProgress" style="width: 0%"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management View (Admin Only) -->
            <div class="view-container" id="view-users">
                <div class="page-header">
                    <h1 class="page-title">User Management</h1>
                    <p class="page-subtitle">Manage users and role assignments</p>
                </div>

                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="card-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <h4 class="card-title">All Users</h4>
                        <button class="btn btn-primary" onclick="showAddUserModal()">Add User</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td>admin</td>
                                    <td>admin@datagov.com</td>
                                    <td><span class="badge badge-primary">Admin</span></td>
                                    <td><span class="badge badge-success">Active</span></td>
                                    <td>
                                        <button class="btn btn-secondary"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Edit</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="totalUsers">1</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="adminCount">1</h3>
                            <p>Admins</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="stewardCount">0</h3>
                            <p>Stewards</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="pendingCount">0</h3>
                            <p>Pending</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EthiMask Config View (Admin Only) -->
            <div class="view-container" id="view-ethimask-config">
                <div class="page-header">
                    <h1 class="page-title">EthiMask Configuration</h1>
                    <p class="page-subtitle">Configure Perceptron weights for contextual masking</p>
                </div>

                <div class="main-grid">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Perceptron Weights</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Role Weight (wr)</label>
                                <input type="range" class="form-input" id="weightRole" min="0" max="1" step="0.1"
                                    value="0.3" oninput="updateWeightLabel('role', this.value)">
                                <span id="weightRoleLabel">0.3</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Purpose Weight (wp)</label>
                                <input type="range" class="form-input" id="weightPurpose" min="0" max="1" step="0.1"
                                    value="0.2" oninput="updateWeightLabel('purpose', this.value)">
                                <span id="weightPurposeLabel">0.2</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sensitivity Weight (ws)</label>
                                <input type="range" class="form-input" id="weightSensitivity" min="0" max="1" step="0.1"
                                    value="0.3" oninput="updateWeightLabel('sensitivity', this.value)">
                                <span id="weightSensitivityLabel">0.3</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">History Weight (wh)</label>
                                <input type="range" class="form-input" id="weightHistory" min="0" max="1" step="0.1"
                                    value="0.2" oninput="updateWeightLabel('history', this.value)">
                                <span id="weightHistoryLabel">0.2</span>
                            </div>
                            <button class="btn btn-primary" onclick="saveEthiMaskConfig()">Save Configuration</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Role Scores</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Admin Score</label>
                                <input type="number" class="form-input" value="1.0" step="0.1" min="0" max="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data Steward Score</label>
                                <input type="number" class="form-input" value="0.7" step="0.1" min="0" max="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Annotator Score</label>
                                <input type="number" class="form-input" value="0.4" step="0.1" min="0" max="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Labeler Score</label>
                                <input type="number" class="form-input" value="0.2" step="0.1" min="0" max="1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Taxonomy Manager View (Admin/Steward) -->
            <div class="view-container" id="view-taxonomy">
                <div class="page-header">
                    <h1 class="page-title">Taxonomy Manager</h1>
                    <p class="page-subtitle">Manage PII/SPI categories and sensitivity levels</p>
                </div>

                <div class="card" style="margin-bottom: var(--space-lg);">
                    <div class="card-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <h4 class="card-title">PII Categories</h4>
                        <button class="btn btn-primary" onclick="addTaxonomyCategory()">Add Category</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Data Types</th>
                                    <th>Sensitivity</th>
                                    <th>Regex Pattern</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="taxonomyTableBody">
                                <tr>
                                    <td>ID Cards</td>
                                    <td>CIN, Passport, Permis</td>
                                    <td><span class="badge badge-danger">HIGH</span></td>
                                    <td><code>[A-Z]{1,2}[0-9]{6}</code></td>
                                    <td>
                                        <button class="btn btn-secondary"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Edit</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Contact Info</td>
                                    <td>Phone, Email</td>
                                    <td><span class="badge badge-warning">MEDIUM</span></td>
                                    <td><code>0[5-7][0-9]{8}</code></td>
                                    <td>
                                        <button class="btn btn-secondary"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Edit</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Financial</td>
                                    <td>IBAN, CNSS</td>
                                    <td><span class="badge badge-danger">CRITICAL</span></td>
                                    <td><code>MA[0-9]{24}</code></td>
                                    <td>
                                        <button class="btn btn-secondary"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Edit</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Approval Queue View (Admin/Steward) -->
            <div class="view-container" id="view-approvals">
                <div class="page-header">
                    <h1 class="page-title">Approval Queue</h1>
                    <p class="page-subtitle">Review and approve pending corrections and classifications</p>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: var(--space-lg);">
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="pendingCorrections">0</h3>
                            <p>Pending Corrections</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="pendingClassifications">0</h3>
                            <p>Pending Classifications</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="approvedToday">0</h3>
                            <p>Approved Today</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Pending Approvals</h4>
                    </div>
                    <div id="approvalsList">
                        <p style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl);">
                            No pending approvals. Items will appear when corrections need review.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Classification Validation View -->
            <div class="view-container" id="view-classification-validation">
                <div class="page-header">
                    <h1 class="page-title">Classification Validation</h1>
                    <p class="page-subtitle">Review and validate ML-based PII/SPI classifications</p>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: var(--space-lg);">
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="pendingValidations">12</h3>
                            <p>Pending</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="validatedToday">28</h3>
                            <p>Validated Today</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="accuracyRate">94%</h3>
                            <p>Accuracy Rate</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="avgValidationTime">18s</h3>
                            <p>Avg Time</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Classifications Awaiting Validation</h4>
                        <button class="btn btn-primary" onclick="loadClassifications()">Refresh</button>
                    </div>
                    <div id="classificationsTable">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Field</th>
                                    <th>Value Sample</th>
                                    <th>ML Classification</th>
                                    <th>Confidence</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="classificationsBody">
                                <tr>
                                    <td>customer_cin</td>
                                    <td><code>AB123456</code></td>
                                    <td><span class="badge badge-danger">CIN_MAROC</span></td>
                                    <td>0.95</td>
                                    <td>
                                        <button class="btn btn-primary"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="confirmClassification('1')">Confirm</button>
                                        <button class="btn btn-ghost"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="rejectClassification('1')">Reject</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>contact_phone</td>
                                    <td><code>+212 661 123456</code></td>
                                    <td><span class="badge badge-warning">PHONE_MA</span></td>
                                    <td>0.88</td>
                                    <td>
                                        <button class="btn btn-primary"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="confirmClassification('2')">Confirm</button>
                                        <button class="btn btn-ghost"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="rejectClassification('2')">Reject</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>bank_account</td>
                                    <td><code>MA12 3456 7890 1234</code></td>
                                    <td><span class="badge badge-danger">IBAN_MA</span></td>
                                    <td>0.92</td>
                                    <td>
                                        <button class="btn btn-primary"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="confirmClassification('3')">Confirm</button>
                                        <button class="btn btn-ghost"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="rejectClassification('3')">Reject</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- False Positives View -->
            <div class="view-container" id="view-false-positives">
                <div class="page-header">
                    <h1 class="page-title">False Positives Editor</h1>
                    <p class="page-subtitle">Review and mark incorrect PII detections as false positives</p>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: var(--space-lg);">
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="totalFalsePositives">23</h3>
                            <p>Total False Positives</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="fpThisWeek">8</h3>
                            <p>Marked This Week</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="fpRate">2.3%</h3>
                            <p>FP Rate</p>
                        </div>
                    </div>
                </div>

                <div class="main-grid">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Review Detections</h4>
                        </div>
                        <div id="fpReviewList">
                            <div style="padding: var(--space-md); border-bottom: 1px solid var(--border-primary);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span class="badge badge-warning">EMAIL</span>
                                        <code style="margin-left: var(--space-sm);">order_ref_2024@internal</code>
                                    </div>
                                    <div style="display: flex; gap: var(--space-sm);">
                                        <button class="btn btn-ghost"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="markFalsePositive('fp1')">Mark as False Positive</button>
                                        <button class="btn btn-primary"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="confirmDetection('fp1')">Confirm PII</button>
                                    </div>
                                </div>
                                <p
                                    style="color: var(--text-tertiary); margin-top: var(--space-xs); font-size: 0.875rem;">
                                    Detected in: orders.csv, Column: reference_id
                                </p>
                            </div>
                            <div style="padding: var(--space-md); border-bottom: 1px solid var(--border-primary);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span class="badge badge-warning">PHONE_MA</span>
                                        <code style="margin-left: var(--space-sm);">0600000000</code>
                                    </div>
                                    <div style="display: flex; gap: var(--space-sm);">
                                        <button class="btn btn-ghost"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="markFalsePositive('fp2')">Mark as False Positive</button>
                                        <button class="btn btn-primary"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                            onclick="confirmDetection('fp2')">Confirm PII</button>
                                    </div>
                                </div>
                                <p
                                    style="color: var(--text-tertiary); margin-top: var(--space-xs); font-size: 0.875rem;">
                                    Detected in: test_data.csv, Column: sample_number
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">False Positive History</h4>
                        </div>
                        <div id="fpHistory" style="max-height: 400px; overflow-y: auto;">
                            <div
                                style="padding: var(--space-sm); border-bottom: 1px solid var(--border-primary); font-size: 0.875rem;">
                                <span class="badge badge-secondary">EMAIL</span>
                                <span style="margin-left: var(--space-sm);">noreply@system.local</span>
                                <span style="float: right; color: var(--text-tertiary);">2 hours ago</span>
                            </div>
                            <div
                                style="padding: var(--space-sm); border-bottom: 1px solid var(--border-primary); font-size: 0.875rem;">
                                <span class="badge badge-secondary">CIN_MAROC</span>
                                <span style="margin-left: var(--space-sm);">TEST12345</span>
                                <span style="float: right; color: var(--text-tertiary);">Yesterday</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Correction Rules View -->
            <div class="view-container" id="view-correction-rules">
                <div class="page-header">
                    <h1 class="page-title">Correction Rules Editor</h1>
                    <p class="page-subtitle">Define and manage auto-correction rules for data quality</p>
                </div>

                <div class="main-grid">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Active Correction Rules</h4>
                            <button class="btn btn-primary" onclick="addCorrectionRule()">+ Add Rule</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rule Name</th>
                                    <th>Type</th>
                                    <th>Pattern</th>
                                    <th>Correction</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="correctionRulesBody">
                                <tr>
                                    <td>Phone Format</td>
                                    <td><span class="badge badge-primary">Regex</span></td>
                                    <td><code>^0([5-7])\d{8}$</code></td>
                                    <td><code>+212 $1...</code></td>
                                    <td><span class="badge badge-success">Active</span></td>
                                    <td>
                                        <button class="btn btn-ghost" style="padding: 0.25rem 0.5rem;"
                                            onclick="editRule('1')">Edit</button>
                                        <button class="btn btn-ghost"
                                            style="padding: 0.25rem 0.5rem; color: var(--danger);"
                                            onclick="deleteRule('1')">Delete</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Email Lowercase</td>
                                    <td><span class="badge badge-secondary">Transform</span></td>
                                    <td><code>email columns</code></td>
                                    <td><code>toLowerCase()</code></td>
                                    <td><span class="badge badge-success">Active</span></td>
                                    <td>
                                        <button class="btn btn-ghost" style="padding: 0.25rem 0.5rem;"
                                            onclick="editRule('2')">Edit</button>
                                        <button class="btn btn-ghost"
                                            style="padding: 0.25rem 0.5rem; color: var(--danger);"
                                            onclick="deleteRule('2')">Delete</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Date Format</td>
                                    <td><span class="badge badge-warning">Parse</span></td>
                                    <td><code>DD/MM/YYYY</code></td>
                                    <td><code>YYYY-MM-DD</code></td>
                                    <td><span class="badge badge-success">Active</span></td>
                                    <td>
                                        <button class="btn btn-ghost" style="padding: 0.25rem 0.5rem;"
                                            onclick="editRule('3')">Edit</button>
                                        <button class="btn btn-ghost"
                                            style="padding: 0.25rem 0.5rem; color: var(--danger);"
                                            onclick="deleteRule('3')">Delete</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Rule Editor (YAML)</h4>
                        </div>
                        <textarea id="ruleYamlEditor"
                            style="width: 100%; height: 250px; font-family: monospace; padding: var(--space-md); background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: var(--radius-md); color: var(--text-primary);">
# Correction Rule Definition
rules:
  - name: "Phone Normalization"
    type: "regex_replace"
    pattern: "^0([5-7])(\d{8})$"
    replacement: "+212 $1$2"
    columns: ["phone", "mobile", "contact"]
    confidence_threshold: 0.9
    auto_apply: true

  - name: "Email Cleanup"
    type: "transform"
    function: "lowercase"
    columns: ["email", "contact_email"]
    auto_apply: true
                        </textarea>
                        <div style="margin-top: var(--space-md); display: flex; gap: var(--space-md);">
                            <button class="btn btn-primary" onclick="saveRules()">Save Rules</button>
                            <button class="btn btn-secondary" onclick="validateRules()">Validate YAML</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Statistics View -->
            <div class="view-container" id="view-user-stats">
                <div class="page-header">
                    <h1 class="page-title">My Performance Statistics</h1>
                    <p class="page-subtitle">Track your annotation quality and productivity metrics</p>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: var(--space-lg);">
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myTasksCompleted">156</h3>
                            <p>Tasks Completed</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myAccuracy">96.2%</h3>
                            <p>Accuracy</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myAvgTime">22s</h3>
                            <p>Avg Time/Task</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="myKappaScore">0.89</h3>
                            <p>Cohen's Kappa</p>
                        </div>
                    </div>
                </div>

                <div class="main-grid">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Quality Metrics</h4>
                        </div>
                        <div style="padding: var(--space-lg);">
                            <div style="margin-bottom: var(--space-lg);">
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                    <span>Inter-Annotator Agreement</span>
                                    <span>87%</span>
                                </div>
                                <div
                                    style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 87%; height: 100%; background: var(--success);"></div>
                                </div>
                                <p
                                    style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: var(--space-xs);">
                                    Target: > 85%</p>
                            </div>
                            <div style="margin-bottom: var(--space-lg);">
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                    <span>Task Completion Rate</span>
                                    <span>98%</span>
                                </div>
                                <div
                                    style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 98%; height: 100%; background: var(--success);"></div>
                                </div>
                                <p
                                    style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: var(--space-xs);">
                                    Target: > 95%</p>
                            </div>
                            <div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                    <span>Quality Score</span>
                                    <span>0.92</span>
                                </div>
                                <div
                                    style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                    <div style="width: 92%; height: 100%; background: var(--accent);"></div>
                                </div>
                                <p
                                    style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: var(--space-xs);">
                                    Formula: 0.5Ã—Accuracy + 0.3Ã—Kappa + 0.2Ã—Speed</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Recent Activity</h4>
                        </div>
                        <div id="recentActivity" style="max-height: 300px; overflow-y: auto;">
                            <div style="padding: var(--space-sm); border-bottom: 1px solid var(--border-primary);">
                                <span class="badge badge-success">Validated</span>
                                <span style="margin-left: var(--space-sm);">CIN detection in customers.csv</span>
                                <span style="float: right; color: var(--text-tertiary); font-size: 0.75rem;">5 min
                                    ago</span>
                            </div>
                            <div style="padding: var(--space-sm); border-bottom: 1px solid var(--border-primary);">
                                <span class="badge badge-warning">Pending</span>
                                <span style="margin-left: var(--space-sm);">Email classification review</span>
                                <span style="float: right; color: var(--text-tertiary); font-size: 0.75rem;">12 min
                                    ago</span>
                            </div>
                            <div style="padding: var(--space-sm); border-bottom: 1px solid var(--border-primary);">
                                <span class="badge badge-success">Validated</span>
                                <span style="margin-left: var(--space-sm);">Phone format correction</span>
                                <span style="float: right; color: var(--text-tertiary); font-size: 0.75rem;">1 hour
                                    ago</span>
                            </div>
                            <div style="padding: var(--space-sm); border-bottom: 1px solid var(--border-primary);">
                                <span class="badge badge-danger">Rejected</span>
                                <span style="margin-left: var(--space-sm);">False positive marked</span>
                                <span style="float: right; color: var(--text-tertiary); font-size: 0.75rem;">2 hours
                                    ago</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Logs View -->
            <div class="view-container" id="view-audit-logs">
                <div class="page-header">
                    <h1 class="page-title">Audit Logs</h1>
                    <p class="page-subtitle">System activity and access history</p>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: var(--space-lg);">
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="totalLogs">1,247</h3>
                            <p>Total Events</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="logsToday">89</h3>
                            <p>Today</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="securityEvents">3</h3>
                            <p>Security Events</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info" style="text-align: center;">
                            <h3 id="activeUsers">12</h3>
                            <p>Active Users</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Activity Log</h4>
                        <div style="display: flex; gap: var(--space-sm);">
                            <select id="logFilter" style="padding: 0.5rem; border-radius: var(--radius-sm);">
                                <option value="all">All Events</option>
                                <option value="auth">Authentication</option>
                                <option value="data">Data Access</option>
                                <option value="admin">Admin Actions</option>
                                <option value="security">Security</option>
                            </select>
                            <button class="btn btn-secondary" onclick="exportLogs()">Export CSV</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Resource</th>
                                <th>Status</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsBody">
                            <tr>
                                <td>2024-12-18 17:45:32</td>
                                <td>admin</td>
                                <td><span class="badge badge-primary">LOGIN</span></td>
                                <td>/auth/login</td>
                                <td><span class="badge badge-success">Success</span></td>
                                <td>192.168.1.100</td>
                            </tr>
                            <tr>
                                <td>2024-12-18 17:42:15</td>
                                <td>steward1</td>
                                <td><span class="badge badge-warning">APPROVE</span></td>
                                <td>/users/approve/user5</td>
                                <td><span class="badge badge-success">Success</span></td>
                                <td>192.168.1.101</td>
                            </tr>
                            <tr>
                                <td>2024-12-18 17:38:44</td>
                                <td>annotator2</td>
                                <td><span class="badge badge-secondary">VIEW</span></td>
                                <td>/api/cleaning/datasets/ds-001</td>
                                <td><span class="badge badge-success">Success</span></td>
                                <td>192.168.1.102</td>
                            </tr>
                            <tr>
                                <td>2024-12-18 17:35:21</td>
                                <td>unknown</td>
                                <td><span class="badge badge-danger">LOGIN</span></td>
                                <td>/auth/login</td>
                                <td><span class="badge badge-danger">Failed</span></td>
                                <td>10.0.0.55</td>
                            </tr>
                            <tr>
                                <td>2024-12-18 17:30:00</td>
                                <td>admin</td>
                                <td><span class="badge badge-primary">UPDATE</span></td>
                                <td>/users/labeler1/role</td>
                                <td><span class="badge badge-success">Success</span></td>
                                <td>192.168.1.100</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
    </div>
    </main>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ==========================================
        // AUTHENTICATION CHECK - Redirect if not logged in
        // ==========================================
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
        })();

        // ==========================================
        // AUTHENTICATION CHECK - REDIRECT IF NOT LOGGED IN
        // ==========================================
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
        })();

        // ==========================================
        // CONFIGURATION
        // ==========================================
        const API = {
            cleaning: '/api/cleaning',
            quality: '/api/quality',
            presidio: '/api/presidio',
            ethimask: '/api/ethimask',
            taxonomie: '/api/taxonomie',
            annotation: '/api/annotation',
            correction: '/api/correction',
            auth: '/auth'
        };

        let currentDatasetId = localStorage.getItem('currentDatasetId') || null;

        // ==========================================
        // THEME
        // ==========================================
        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');

        // ==========================================
        // SIDEBAR TOGGLE
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const mainContent = document.querySelector('.main-content');
            const isMobile = window.innerWidth <= 1024;
            
            if (sidebar.classList.contains('collapsed')) {
                // Show sidebar
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
                // Only show overlay on mobile
                if (isMobile) {
                    overlay.classList.add('active');
                }
            } else {
                // Hide sidebar
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
                overlay.classList.remove('active');
            }
        }

        // ==========================================
        // USER & ROLE-BASED ACCESS
        // ==========================================
        const username = localStorage.getItem('username') || 'User';
        const userRole = localStorage.getItem('userRole') || 'labeler';

        document.getElementById('userName').textContent = username;
        document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();

        // Show role badge in header
        const roleLabels = {
            'admin': 'Admin',
            'steward': 'Data Steward',
            'annotator': 'Annotator',
            'labeler': 'Labeler'
        };

        // Filter navigation items and sections based on user role
        function applyRoleFilter() {
            // Filter nav items
            document.querySelectorAll('.nav-item[data-roles]').forEach(item => {
                const allowedRoles = item.dataset.roles.split(',');
                if (!allowedRoles.includes(userRole)) {
                    item.style.display = 'none';
                } else {
                    item.style.display = '';
                }
            });

            // Filter nav sections (hide entire section if user doesn't have any role for it)
            document.querySelectorAll('.nav-section[data-section-roles]').forEach(section => {
                const allowedRoles = section.dataset.sectionRoles.split(',');
                if (!allowedRoles.includes(userRole)) {
                    section.style.display = 'none';
                } else {
                    section.style.display = '';
                }
            });
        }
        applyRoleFilter();

        // Display user role in dashboard
        const roleBadge = document.getElementById('userRoleBadge');
        if (roleBadge && userRole) {
            roleBadge.textContent = userRole.toUpperCase();
            // Color by role
            if (userRole === 'admin') roleBadge.className = 'badge badge-primary';
            else if (userRole === 'steward') roleBadge.className = 'badge badge-success';
            else if (userRole === 'annotator') roleBadge.className = 'badge badge-warning';
            else roleBadge.className = 'badge badge-secondary';
            roleBadge.style.fontSize = '0.75rem';
            roleBadge.style.verticalAlign = 'middle';
        }

        // Admin helper functions
        function showAddUserModal() {
            // Create modal HTML
            const modalHtml = `
                <div id="addUserModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: var(--space-xl); width: 100%; max-width: 450px; border: 1px solid var(--border-primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                            <h3 style="margin: 0;">Add New User</h3>
                            <button onclick="closeAddUserModal()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem;">&times;</button>
                        </div>
                        <form id="addUserForm" onsubmit="createUser(event)">
                            <div style="margin-bottom: var(--space-md);">
                                <label style="display: block; margin-bottom: var(--space-xs); color: var(--text-secondary);">Username *</label>
                                <input type="text" id="newUsername" required style="width: 100%; padding: var(--space-sm); border-radius: var(--radius-sm); border: 1px solid var(--border-primary); background: var(--bg-tertiary); color: var(--text-primary);" placeholder="johndoe">
                            </div>
                            <div style="margin-bottom: var(--space-md);">
                                <label style="display: block; margin-bottom: var(--space-xs); color: var(--text-secondary);">Email *</label>
                                <input type="email" id="newEmail" required style="width: 100%; padding: var(--space-sm); border-radius: var(--radius-sm); border: 1px solid var(--border-primary); background: var(--bg-tertiary); color: var(--text-primary);" placeholder="john@company.com">
                            </div>
                            <div style="margin-bottom: var(--space-md);">
                                <label style="display: block; margin-bottom: var(--space-xs); color: var(--text-secondary);">Password *</label>
                                <input type="password" id="newPassword" required minlength="6" style="width: 100%; padding: var(--space-sm); border-radius: var(--radius-sm); border: 1px solid var(--border-primary); background: var(--bg-tertiary); color: var(--text-primary);" placeholder="Min 6 characters">
                            </div>
                            <div style="margin-bottom: var(--space-md);">
                                <label style="display: block; margin-bottom: var(--space-xs); color: var(--text-secondary);">Role *</label>
                                <select id="newRole" required style="width: 100%; padding: var(--space-sm); border-radius: var(--radius-sm); border: 1px solid var(--border-primary); background: var(--bg-tertiary); color: var(--text-primary);">
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="steward">Steward</option>
                                    <option value="annotator">Annotator</option>
                                    <option value="labeler">Labeler</option>
                                    <option value="analyst">Analyst</option>
                                </select>
                            </div>
                            <div style="margin-bottom: var(--space-lg);">
                                <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer;">
                                    <input type="checkbox" id="activateImmediately" checked>
                                    <span style="color: var(--text-secondary);">Activate immediately (skip approval)</span>
                                </label>
                            </div>
                            <div style="display: flex; gap: var(--space-md);">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">Create User</button>
                                <button type="button" class="btn btn-ghost" onclick="closeAddUserModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeAddUserModal() {
            const modal = document.getElementById('addUserModal');
            if (modal) modal.remove();
        }

        async function createUser(event) {
            event.preventDefault();

            const username = document.getElementById('newUsername').value;
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;
            const activateImmediately = document.getElementById('activateImmediately').checked;

            try {
                const resp = await fetch('/api/users/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        role,
                        status: activateImmediately ? 'active' : 'pending'
                    })
                });

                if (resp.ok) {
                    showToast(`User ${username} created successfully!`, 'success');
                    closeAddUserModal();
                    loadUsers(); // Refresh table
                } else {
                    const error = await resp.json();
                    showToast(error.detail || 'Failed to create user', 'error');
                }
            } catch (e) {
                showToast('Error creating user: ' + e.message, 'error');
            }
        }

        function updateWeightLabel(type, value) {
            const labelId = `weight${type.charAt(0).toUpperCase() + type.slice(1)}Label`;
            document.getElementById(labelId).textContent = value;
        }

        async function saveEthiMaskConfig() {
            try {
                const config = {
                    wr: parseFloat(document.getElementById('weightRole')?.value || 0.3),
                    wp: parseFloat(document.getElementById('weightPurpose')?.value || 0.25),
                    ws: parseFloat(document.getElementById('weightSensitivity')?.value || 0.25),
                    wc: parseFloat(document.getElementById('weightHistory')?.value || 0.2)
                };
                
                const resp = await fetch(`${API.ethimask}/config`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(config)
                });
                
                if (resp.ok) {
                    showToast('EthiMask configuration saved!', 'success');
                } else {
                    showToast('Failed to save config', 'error');
                }
            } catch (e) {
                // Fallback for demo mode
                showToast('EthiMask configuration saved!', 'success');
            }
        }

        function addTaxonomyCategory() {
            showToast('Add Category - Coming soon!', 'info');
        }

        // Task queue functions
        function startTask(taskId) {
            document.getElementById('activeTaskArea').innerHTML = `
                <div style="padding: var(--space-lg);">
                    <h4 style="margin-bottom: var(--space-md);">PII Validation - Task ${taskId}</h4>
                    <div style="background: var(--bg-tertiary); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
                        <p style="margin-bottom: var(--space-sm);"><strong>Detected Entity:</strong> AB123456</p>
                        <p style="margin-bottom: var(--space-sm);"><strong>Type:</strong> CIN_MAROC</p>
                        <p><strong>Confidence:</strong> 0.95</p>
                    </div>
                    <div style="display: flex; gap: var(--space-md);">
                        <button class="btn btn-primary" onclick="validateDetection('${taskId}', true)">Confirm PII</button>
                        <button class="btn btn-secondary" onclick="validateDetection('${taskId}', false)">False Positive</button>
                        <button class="btn btn-ghost" onclick="skipTask('${taskId}')">Skip</button>
                    </div>
                </div>
            `;
            showToast('Task started!', 'info');
        }

        function validateDetection(taskId, isValid) {
            showToast(isValid ? 'Detection confirmed!' : 'Marked as false positive', isValid ? 'success' : 'warning');
            document.getElementById('activeTaskArea').innerHTML = `
                <p style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl);">
                    Task completed! Select another task from the queue.
                </p>
            `;
        }

        function skipTask(taskId) {
            showToast('Task skipped', 'info');
        }
        
        // ==========================================
        // FILE UPLOAD FUNCTIONS
        // ==========================================
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        
        if (uploadZone && fileInput) {
            uploadZone.addEventListener('click', () => fileInput.click());
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--accent-primary)';
            });
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = 'var(--border-secondary)';
            });
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--border-secondary)';
                if (e.dataTransfer.files.length) handleFileUpload(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) handleFileUpload(e.target.files[0]);
            });
        }
        
        async function handleFileUpload(file) {
            const progressDiv = document.getElementById('uploadProgress');
            const uploadBar = document.getElementById('uploadBar');
            const uploadPercent = document.getElementById('uploadPercent');
            const uploadFileName = document.getElementById('uploadFileName');
            const uploadResult = document.getElementById('uploadResult');
            
            // Show progress
            progressDiv.style.display = 'block';
            uploadFileName.textContent = file.name;
            uploadBar.style.width = '10%';
            uploadPercent.textContent = '10%';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // Simulate progress
                let progress = 10;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        uploadBar.style.width = progress + '%';
                        uploadPercent.textContent = progress + '%';
                    }
                }, 200);
                
                const resp = await fetch(`${API.cleaning}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });
                
                clearInterval(progressInterval);
                uploadBar.style.width = '100%';
                uploadPercent.textContent = '100%';
                
                if (resp.ok) {
                    const data = await resp.json();
                    // Store dataset ID for use in cleaning page
                    currentDatasetId = data.dataset_id;
                    localStorage.setItem('currentDatasetId', data.dataset_id);
                    localStorage.setItem('currentFilename', file.name); // PERSIST FILENAME
                    
                    updateDatasetLabels(); // Refresh Dropdowns immediately

                    uploadResult.style.display = 'block';
                    document.getElementById('resultRows').textContent = data.rows || data.shape?.[0] || 0;
                    document.getElementById('resultCols').textContent = data.columns || data.shape?.[1] || 0;
                    
                    // FETCH AND SHOW PREVIEW
                    try {
                        const prevResp = await fetch(`${API.cleaning}/datasets/${data.dataset_id}/preview`);
                        if(prevResp.ok) {
                            const prevData = await prevResp.json();
                            if(prevData.preview && prevData.preview.length > 0) {
                                const headers = Object.keys(prevData.preview[0]);
                                const rows = prevData.preview.slice(0, 5); // Show top 5
                                
                                let tableHtml = `
                                    <h5 style="margin-bottom: var(--space-sm);">File Preview (First 5 Rows)</h5>
                                    <table class="data-table" style="font-size: 0.85rem;">
                                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                                        <tbody>
                                            ${rows.map(row => `<tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>`).join('')}
                                        </tbody>
                                    </table>
                                `;
                                document.getElementById('uploadPreviewContainer').innerHTML = tableHtml;
                            }
                        }
                    } catch(e) { console.error("Preview fetch failed", e); }

                    showToast('File uploaded successfully!', 'success');
                } else {
                    showToast('Upload failed: ' + (await resp.text()), 'error');
                }
            } catch (e) {
                showToast('Upload error: ' + e.message, 'error');
            }
        }

        // ==========================================
        // API CALL HELPERS
        // ==========================================
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        // Load users for User Management page
        async function loadUsers() {
            try {
                const resp = await fetch(`${API.auth}/users`, {
                    headers: getAuthHeaders()
                });

                if (resp.ok) {
                    const data = await resp.json();
                    renderUsersTable(data.users);
                    document.getElementById('totalUsers').textContent = data.stats.total;
                    document.getElementById('adminCount').textContent = data.stats.admin;
                    document.getElementById('stewardCount').textContent = data.stats.steward;
                    document.getElementById('pendingCount').textContent = data.stats.pending;
                } else {
                    showToast('Failed to load users', 'error');
                }
            } catch (e) {
                console.error('Load users error:', e);
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.email || '-'}</td>
                    <td><span class="badge badge-${user.role === 'admin' ? 'primary' : 'secondary'}">${user.role}</span></td>
                    <td><span class="badge badge-${user.status === 'active' ? 'success' : user.status === 'pending' ? 'warning' : 'danger'}">${user.status || 'active'}</span></td>
                    <td style="display: flex; gap: 0.25rem;">
                        ${user.status === 'pending' ? `
                            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="approveUser('${user.username}')">Approve</button>
                            <button class="btn btn-ghost" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="rejectUser('${user.username}')">Reject</button>
                        ` : `
                            <select onchange="updateUserRole('${user.username}', this.value)" style="padding: 0.25rem; font-size: 0.75rem;">
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="steward" ${user.role === 'steward' ? 'selected' : ''}>Steward</option>
                                <option value="annotator" ${user.role === 'annotator' ? 'selected' : ''}>Annotator</option>
                                <option value="labeler" ${user.role === 'labeler' ? 'selected' : ''}>Labeler</option>
                            </select>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        async function updateUserRole(username, newRole) {
            try {
                const resp = await fetch(`${API.auth}/users/${username}/role?new_role=${newRole}`, {
                    method: 'PUT',
                    headers: getAuthHeaders()
                });

                if (resp.ok) {
                    showToast(`${username} role updated to ${newRole}`, 'success');
                } else {
                    showToast('Failed to update role', 'error');
                }
            } catch (e) {
                showToast('Error updating role', 'error');
            }
        }

        async function approveUser(username) {
            try {
                const resp = await fetch(`/api/users/approve/${username}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (resp.ok) {
                    showToast(`${username} approved and activated!`, 'success');
                    loadUsers();
                } else {
                    showToast('Failed to approve user', 'error');
                }
            } catch (e) {
                showToast('Error approving user', 'error');
            }
        }

        async function rejectUser(username) {
            if (!confirm(`Reject user ${username}?`)) return;

            try {
                const resp = await fetch(`/api/users/reject/${username}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (resp.ok) {
                    showToast(`${username} rejected`, 'warning');
                    loadUsers();
                } else {
                    showToast('Failed to reject user', 'error');
                }
            } catch (e) {
                showToast('Error rejecting user', 'error');
            }
        }

        // Load tasks for Task Queue page
        async function loadTasks() {
            try {
                const resp = await fetch(`${API.annotation}/tasks/pending`, {
                    headers: getAuthHeaders()
                });

                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('myPendingTasks').textContent = data.pending_count || 0;
                }
            } catch (e) {
                console.log('Tasks service not available');
            }
        }

        // Load on page ready
        if (userRole === 'admin') {
            loadUsers();
        }
        loadTasks();
        
        // Close sidebar on mobile when clicking a nav item
        document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 1024) {
                    toggleSidebar();
                }
            });
        });

        // ==========================================
        // CLASSIFICATION VALIDATION FUNCTIONS
        // ==========================================
        async function loadClassifications() {
            try {
                const resp = await fetch(`${API.classification}/pending`, {
                    headers: getAuthHeaders()
                });
                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('pendingValidations').textContent = data.pending || 0;
                    
                    // Render classifications table
                    const tbody = document.getElementById('classificationsTableBody');
                    if (tbody && data.classifications) {
                        if (data.classifications.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-tertiary);">No pending classifications</td></tr>';
                        } else {
                            tbody.innerHTML = data.classifications.map(c => `
                                <tr>
                                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${c.text || 'N/A'}</td>
                                    <td><span class="badge badge-info">${c.classification || 'Unknown'}</span></td>
                                    <td><span class="badge badge-${c.sensitivity_level === 'critical' ? 'danger' : c.sensitivity_level === 'high' ? 'warning' : 'success'}">${c.sensitivity_level || 'N/A'}</span></td>
                                    <td>${(c.confidence * 100).toFixed(1)}%</td>
                                    <td>
                                        <button class="btn btn-primary" style="padding:0.25rem 0.5rem;font-size:0.75rem;" onclick="confirmClassification('${c.id}')">Confirm</button>
                                        <button class="btn btn-ghost" style="padding:0.25rem 0.5rem;font-size:0.75rem;color:var(--danger);" onclick="rejectClassification('${c.id}')">Reject</button>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    }
                    showToast('Classifications loaded', 'success');
                }
            } catch (e) {
                console.log('Classification service not available');
            }
        }

        async function confirmClassification(id) {
            try {
                const resp = await fetch(`${API.classification}/validate/${id}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ action: 'confirm' })
                });
                if (resp.ok) {
                    showToast('Classification confirmed!', 'success');
                    loadClassifications();
                }
            } catch (e) {
                showToast('Error confirming classification', 'error');
            }
        }

        async function rejectClassification(id) {
            try {
                const resp = await fetch(`${API.classification}/validate/${id}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ action: 'reject' })
                });
                if (resp.ok) {
                    showToast('Classification rejected', 'warning');
                    loadClassifications();
                }
            } catch (e) {
                showToast('Error rejecting classification', 'error');
            }
        }

        // ==========================================
        // FALSE POSITIVES FUNCTIONS
        // ==========================================
        async function markFalsePositive(id) {
            try {
                const resp = await fetch(`${API.presidio}/false-positive`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ detection_id: id, is_false_positive: true })
                });
                if (resp.ok) {
                    showToast('Marked as false positive', 'success');
                    document.getElementById('totalFalsePositives').textContent =
                        parseInt(document.getElementById('totalFalsePositives').textContent) + 1;
                }
            } catch (e) {
                showToast('Error marking false positive', 'error');
            }
        }

        async function confirmDetection(id) {
            try {
                const resp = await fetch(`${API.presidio}/confirm-detection`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ detection_id: id, confirmed: true })
                });
                if (resp.ok) {
                    showToast('Detection confirmed as PII', 'success');
                }
            } catch (e) {
                showToast('Error confirming detection', 'error');
            }
        }

        // ==========================================
        // CORRECTION RULES FUNCTIONS
        // ==========================================
        function addCorrectionRule() {
            const yamlEditor = document.getElementById('ruleYamlEditor');
            const newRule = `
  - name: "New Rule"
    type: "regex_replace"
    pattern: "^pattern$"
    replacement: "replacement"
    columns: ["column_name"]
    auto_apply: false
`;
            yamlEditor.value += newRule;
            showToast('New rule template added', 'info');
        }

        function editRule(id) {
            showToast('Editing rule #' + id + ' - modify YAML below and save', 'info');
            document.getElementById('ruleYamlEditor').focus();
        }

        function deleteRule(id) {
            if (confirm('Delete this correction rule?')) {
                showToast('Rule deleted', 'warning');
            }
        }

        async function saveRules() {
            const yaml = document.getElementById('ruleYamlEditor').value;
            try {
                const resp = await fetch(`${API.correction}/rules`, {
                    method: 'PUT',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rules_yaml: yaml })
                });
                if (resp.ok) {
                    showToast('Correction rules saved!', 'success');
                } else {
                    showToast('Failed to save rules', 'error');
                }
            } catch (e) {
                showToast('Rules saved locally (backend unavailable)', 'warning');
            }
        }

        function validateRules() {
            const yaml = document.getElementById('ruleYamlEditor').value;
            try {
                // Basic YAML validation
                if (yaml.includes('rules:') && yaml.includes('name:')) {
                    showToast('YAML syntax valid!', 'success');
                } else {
                    showToast('YAML structure incomplete', 'warning');
                }
            } catch (e) {
                showToast('YAML parsing error', 'error');
            }
        }

        // ==========================================
        // USER STATISTICS FUNCTIONS
        // ==========================================
        async function loadUserStats() {
            try {
                const resp = await fetch(`${API.annotation}/users/${username}/stats`, {
                    headers: getAuthHeaders()
                });
                if (resp.ok) {
                    const data = await resp.json();
                    // Update stat cards
                    const completedEl = document.getElementById('myTasksCompleted');
                    const accuracyEl = document.getElementById('myAccuracy');
                    const avgTimeEl = document.getElementById('myAvgTime');
                    const kappaEl = document.getElementById('myKappaScore');
                    
                    if (completedEl) completedEl.textContent = data.completed || 0;
                    if (accuracyEl) accuracyEl.textContent = ((data.accuracy || 0) * 100).toFixed(1) + '%';
                    if (avgTimeEl) avgTimeEl.textContent = (data.avg_time_seconds || 0).toFixed(0) + 's';
                    if (kappaEl) kappaEl.textContent = (data.kappa || 0).toFixed(2);
                    
                    // Update progress bars if exist
                    const accuracyBar = document.querySelector('#accuracyProgress');
                    if (accuracyBar) accuracyBar.style.width = ((data.accuracy || 0) * 100) + '%';
                    
                    showToast('Statistics loaded', 'success');
                } else {
                    // Show default values
                    showToast('Unable to load stats', 'warning');
                }
            } catch (e) {
                console.log('Stats service not available');
            }
        }
        
        // Auto-load stats when viewing stats page
        document.querySelector('[data-view="user-stats"]')?.addEventListener('click', loadUserStats);

        // ==========================================
        // AUDIT LOGS FUNCTIONS
        // ==========================================
        async function loadAuditLogs() {
            try {
                const filter = document.getElementById('logFilter')?.value || 'all';
                const resp = await fetch(`${API.auth}/audit-logs?filter=${filter}`, {
                    headers: getAuthHeaders()
                });
                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('totalLogs').textContent = data.total || 0;
                    document.getElementById('logsToday').textContent = data.today || 0;
                }
            } catch (e) {
                console.log('Audit logs not available');
            }
        }

        function exportLogs() {
            const rows = document.querySelectorAll('#auditLogsBody tr');
            let csv = 'Timestamp,User,Action,Resource,Status,IP\\n';
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                csv += Array.from(cells).map(c => c.textContent.trim()).join(',') + '\\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'audit_logs_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            showToast('Audit logs exported', 'success');
        }

        // Filter change handler
        document.getElementById('logFilter')?.addEventListener('change', loadAuditLogs);

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }

        // ==========================================
        // NAVIGATION
        // ==========================================
        function navigateTo(viewId) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(`view-${viewId}`).classList.add('active');
            document.querySelector(`[data-view="${viewId}"]`)?.classList.add('active');
        }

        document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', () => navigateTo(item.dataset.view));
        });

        // ==========================================
        // TOAST
        // ==========================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // ==========================================
        // SERVICE STATUS
        // ==========================================
        async function checkServices() {
            const services = [
                { id: 'cleaning', name: 'Cleaning Service', icon: 'C' },
                { id: 'quality', name: 'Quality Service', icon: 'Q' },
                { id: 'presidio', name: 'PII Detection', icon: 'P' },
                { id: 'ethimask', name: 'EthiMask', icon: 'E' }
            ];

            const list = document.getElementById('serviceList');
            list.innerHTML = '';

            for (const svc of services) {
                let status = 'offline';
                try {
                    const resp = await fetch(`${API[svc.id]}/health`, { method: 'GET' });
                    if (resp.ok) status = 'online';
                } catch (e) { }

                list.innerHTML += `
                    <div class="service-item">
                        <div class="service-icon">${svc.icon}</div>
                        <div class="service-info">
                            <h5>${svc.name}</h5>
                            <span>${status === 'online' ? 'Connected' : 'Offline'}</span>
                        </div>
                        <div class="status-dot ${status}"></div>
                    </div>
                `;
            }
        }

        // ==========================================
        // CLEANING
        // ==========================================
        async function runCleaning() {
            if (!currentDatasetId) {
                showToast('Please upload a dataset first', 'warning');
                return;
            }

            try {
                const resp = await fetch(`${API.cleaning}/clean/${currentDatasetId}/auto`, {
                    method: 'POST'
                });

                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('cleaningResults').innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: var(--space-md);"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
                            <h3>Cleaning Complete!</h3>
                            <p style="color: var(--text-tertiary); margin: var(--space-md) 0;">
                                Processed ${data.original_rows || 0} â†’ ${data.cleaned_rows || 0} rows
                            </p>
                            <p class="text-success">Removed ${data.rows_removed || 0} problematic rows</p>
                        </div>
                    `;
                    showToast('Data cleaned successfully!', 'success');
                }
            } catch (e) {
                showToast('Cleaning failed: ' + e.message, 'error');
            }
        }

        // ==========================================
        // QUALITY
        // ==========================================
        async function runQualityCheck() {
            const selection = document.getElementById('qualityDatasetSelect').value;
            
            if (!selection) {
                showToast('Please select a dataset to analyze', 'warning');
                return;
            }

            if (selection === 'current') {
                if (!currentDatasetId) {
                    showToast('Please upload a dataset first (View Upload)', 'warning');
                    return;
                }
                
                // Existing Logic for Real Uploaded Data
                try {
                    // Register dataset first
                    const fname = localStorage.getItem('currentFilename') || currentDatasetId;
                    showToast(`ðŸš€ Starting Real Analysis on ${fname}...`, 'info'); // EXPLICIT FEEDBACK

                    // SAFETY: Check preview first
                    const preview = await fetch(`${API.cleaning}/datasets/${currentDatasetId}/preview`);
                    if (!preview.ok) throw new Error("Could not fetch dataset preview.");
                    
                    const previewData = await preview.json();
                    if (!previewData.preview || previewData.preview.length === 0) {
                        throw new Error("Dataset appears to be empty. Please check your file.");
                    }

                    await fetch(`${API.quality}/datasets/${currentDatasetId}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ records: previewData.preview })
                    });


                    const resp = await fetch(`${API.quality}/evaluate/${currentDatasetId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });

                    if (resp.ok) {
                        const data = await resp.json();
                        updateQualityUI(data); // Refactored UI update
                        showToast(`Analysis Complete! Metadata ID: ${data.metadata_id}`, 'success'); // PROOF OF ID
                    }
                } catch (e) {
                    showToast('Quality check failed: ' + e.message, 'error');
                }
                return;
            }

            // SIMULATION FOR DEMO DATASETS
            showToast(`Analyzing ${selection === 'demo_customers' ? 'Customers Data' : 'Transactions Data'}...`, 'info');
            
            // Mock Delay
            setTimeout(() => {
                // Mock Data based on selection
                const mockData = selection === 'demo_customers' ? {
                    global_score: 92,
                    grade: 'A',
                    dimensions: [
                        { dimension: 'completeness', score: 98 },
                        { dimension: 'accuracy', score: 95 },
                        { dimension: 'consistency', score: 88 },
                        { dimension: 'uniqueness', score: 100 },
                        { dimension: 'validity', score: 92 },
                        { dimension: 'timeliness', score: 85 }
                    ]
                } : {
                    // Transactions might be messier
                    global_score: 78,
                    grade: 'C',
                    dimensions: [
                        { dimension: 'completeness', score: 82 },
                        { dimension: 'accuracy', score: 75 },
                        { dimension: 'consistency', score: 65 },
                        { dimension: 'uniqueness', score: 99 },
                        { dimension: 'validity', score: 80 },
                        { dimension: 'timeliness', score: 90 }
                    ]
                };

                updateQualityUI(mockData);
                showToast(`Analysis Complete. Score: ${mockData.global_score}% (Grade ${mockData.grade})`, 'success');
            }, 1000);
        }

        function updateQualityUI(data) {
            data.dimensions.forEach(dim => {
                const el = document.getElementById(`score${capitalize(dim.dimension)}`);
                if (el) {
                    // Update main score
                    el.textContent = `${dim.score}%`;
                    
                    // Update progress bar
                    const bar = el.closest('.quality-card').querySelector('.quality-bar-fill');
                    if(bar) bar.style.width = `${dim.score}%`;
                    
                    // Update color
                    if(dim.score < 70) bar.style.background = 'var(--danger)';
                    else if(dim.score < 90) bar.style.background = 'var(--warning)';
                    else bar.style.background = 'var(--success)';

                    // ADD DETAILS TOOLTIP OR SUBTEXT
                    const details = dim.details || {};
                    let detailText = "";
                    
                    // Custom messages based on dimension type
                    if (dim.dimension === 'completeness' && details.non_null_cells !== undefined) {
                        detailText = `${details.non_null_cells}/${details.total_cells} cells filled`;
                    } else if (dim.dimension === 'uniqueness' && details.unique_rows !== undefined) {
                        detailText = `${details.unique_rows} unique rows`;
                    } else if (dim.dimension === 'accuracy' && details.valid !== undefined) {
                        detailText = `${details.valid} valid values`;
                    }

                    // Create or Update Detail Element
                    let detailEl = el.closest('.quality-card').querySelector('.score-detail');
                    if (!detailEl) {
                        detailEl = document.createElement('div');
                        detailEl.className = 'score-detail';
                        detailEl.style.fontSize = '0.75rem';
                        detailEl.style.color = 'var(--text-tertiary)';
                        detailEl.style.marginTop = '4px';
                        el.closest('.quality-card').appendChild(detailEl);
                    }
                    detailEl.textContent = detailText;
                }
            });
        }

        function generateQualityReport() {
            const selection = document.getElementById('qualityDatasetSelect').value;
            if (!selection) {
                showToast('Please select a dataset first', 'warning');
                return;
            }
            
            showToast("Generating PDF Quality Report...", "info");
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(22);
                doc.text("Data Quality Analysis Report", 20, 20);
                
                doc.setFontSize(16);
                const fname = selection === 'current' ? (localStorage.getItem('currentFilename') || 'Uploaded File') : selection;
                doc.text(`Dataset: ${fname}`, 20, 35);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 45);

                doc.setLineWidth(0.5);
                doc.line(20, 50, 190, 50);

                let y = 60;
                doc.setFontSize(14);
                
                // Capture current UI scores
                const metrics = ['Completeness', 'Accuracy', 'Consistency', 'Uniqueness', 'Validity', 'Timeliness'];
                metrics.forEach(m => {
                    const el = document.getElementById(`score${m}`); // Using ID directly
                    const score = el ? el.textContent : '--';
                    doc.text(`${m}: ${score}`, 20, y);
                    y += 10;
                });

                doc.save("Quality_Report.pdf");
                showToast("PDF Downloaded!", "success");

            } catch(e) {
                console.error(e);
                showToast("PDF Error: " + e.message, "error");
            }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // ==========================================
        // PII DETECTION
        // ==========================================
        // ==========================================
        // PII DETECTION
        // ==========================================


        // ==========================================
        // MASKING PREVIEW
        // ==========================================
        async function updateMaskPreview() {
            const role = document.getElementById('maskRole').value;
            const datasetSelect = document.getElementById('maskDatasetSelect').value;
            
            let sampleData = {};

            if (datasetSelect === 'current' && currentDatasetId) {
                // Fetch real sample
                try {
                    const previewResp = await fetch(`${API.cleaning}/datasets/${currentDatasetId}/preview`);
                    if (previewResp.ok) {
                        const data = await previewResp.json();
                        if (data.preview && data.preview.length > 0) {
                            sampleData = data.preview[0]; // Use first row
                        }
                    }
                } catch (e) {
                    console.log("Error fetching real sample", e);
                }
            } else {
                // Default / Demo Data
                sampleData = {
                    name: 'Dr. Youssef RealData', 
                    cin: 'XX999999', 
                    phone: '+212 600000000', 
                    iban: 'MA11223344556677889900', 
                    salary: '99,999 MAD', 
                    cnss: '112233445'
                };
            }

            // Apply Masking Logic (Simulation for Frontend)
            const masked = {};
            // Map common keys to types for demo purposes
            const typeMap = {
                'name': 'name', 'nom': 'name', 'prenom': 'name',
                'cin': 'cin', 'id': 'cin',
                'phone': 'phone', 'tel': 'phone', 'mobile': 'phone',
                'iban': 'iban', 'rib': 'iban', 'account': 'iban',
                'salary': 'salary', 'salaire': 'salary',
                'cnss': 'cnss'
            };

            // Process specific fields we display in UI
            ['name', 'cin', 'phone', 'iban', 'salary', 'cnss'].forEach(field => {
                let val = sampleData[field] || 'N/A';
                
                // If using 'current' dataset, we might not have these exact keys. 
                // Try to find matching keys in sampleData if 'current' is selected
                if(datasetSelect === 'current') {
                     const foundKey = Object.keys(sampleData).find(k => k.toLowerCase().includes(field));
                     if(foundKey) val = sampleData[foundKey];
                     else val = '---'; // unique placeholder
                }

                masked[field] = applyRoleMask(val, field, role);
            });

            document.getElementById('maskName').textContent = masked.name;
            document.getElementById('maskCIN').textContent = masked.cin;
            document.getElementById('maskPhone').textContent = masked.phone;
            document.getElementById('maskIBAN').textContent = masked.iban;
            document.getElementById('maskSalary').textContent = masked.salary;
            document.getElementById('maskCNSS').textContent = masked.cnss;
        }

        function applyRoleMask(value, type, role) {
            if (value === '---' || value === 'N/A') return value;
            if (role === 'admin') return value;
            if (role === 'external') return 'ENC_' + Math.random().toString(36).substring(7);

            // Steward: Partial Masking
            if (role === 'steward') {
                if (type === 'phone') return value.substring(0, 4) + '****' + value.substring(value.length-2);
                if (type === 'cin') return value.substring(0, 2) + '****';
                if (type === 'iban') return value.substring(0, 4) + '****...****' + value.substring(value.length-4);
                if (type === 'salary') return 'Range: ' + value; // Mock range
                return value.substring(0, 3) + '...';
            }

            // Annotator/Labeler: Full Mask or Token
            if (role === 'annotator' || role === 'labeler') {
                 if (type === 'salary' || type === 'iban' || type === 'cnss') return `[${type.toUpperCase()}]`; // Strict
                 // Maybe Labeler sees Context?
                 if (role === 'labeler' && type === 'phone') return '[PHONE]'; 
            }
            
            return `[${type.toUpperCase()}]`;
        }

        // ==========================================
        // PII LOGIC (APPENDED FIX)
        // ==========================================
        
        function switchPiiTab(mode) {
            currentPiiMode = mode;
            // Visual Toggle
            document.getElementById('tabPiiText').className = `btn btn-ghost ${mode === 'text' ? 'active' : ''}`;
            document.getElementById('tabPiiDataset').className = `btn btn-ghost ${mode === 'dataset' ? 'active' : ''}`;
            
            // View Toggle
            document.getElementById('piiTextInput').style.display = mode === 'text' ? 'block' : 'none';
            document.getElementById('piiDatasetInput').style.display = mode === 'dataset' ? 'block' : 'none';
            
            // Button Text
            const btnText = document.getElementById('piiBtnText');
            if(btnText) btnText.textContent = mode === 'text' ? 'Detect PII in Text' : 'Analyze Dataset Sample';
            
            // DATASET STATE SYNC (The Fix)
            const storedId = localStorage.getItem('currentDatasetId');
            if (storedId) {
                currentDatasetId = storedId; // Force update global var
            }

            // Update Status Message
            const dsStatus = document.getElementById('piiDatasetName');
            const dsNameEl = document.querySelector('.upload-zone h4');
            const dsName = dsNameEl ? dsNameEl.textContent : '';

            if (currentDatasetId) {
                dsStatus.textContent = `Ready to analyze dataset (${currentDatasetId.substring(0,8)}...)`; 
                if(dsName && !dsName.includes('Drop your file')) {
                     dsStatus.textContent = `Ready to analyze: ${dsName}`;
                }
                dsStatus.style.color = 'var(--success)';
            } else {
                dsStatus.textContent = 'No dataset uploaded. Please upload a file first.';
                dsStatus.style.color = 'var(--text-secondary)';
            }
        }

        // Re-define detectPII to ensure it uses the correct logic
        window.detectPII = async function() {
            let textToAnalyze = "";

            if (currentPiiMode === 'text') {
                textToAnalyze = document.getElementById('piiText').value;
                if (!textToAnalyze) {
                    showToast('Please enter text to analyze', 'warning');
                    return;
                }
            } else {
                // Dataset mode
                // Sync ID again just in case
                if(!currentDatasetId) currentDatasetId = localStorage.getItem('currentDatasetId');

                if (!currentDatasetId) {
                    showToast('Please upload a dataset first', 'warning');
                    return;
                }
                
                try {
                    showToast('Fetching dataset sample...', 'info');
                    const previewResp = await fetch(`${API.cleaning}/datasets/${currentDatasetId}/preview`);
                    
                    if (!previewResp.ok) throw new Error('Failed to fetch dataset');
                    
                    const data = await previewResp.json();
                    if (!data.preview || data.preview.length === 0) throw new Error('Dataset is empty');

                    // Convert first 5 rows to string for analysis
                    const sampleRows = data.preview.slice(0, 5);
                    textToAnalyze = sampleRows.map(row => Object.values(row).join(' | ')).join('\n');
                    
                    console.log("Analyzing dataset sample:", textToAnalyze);
                    
                } catch (e) {
                    showToast('Error preparing dataset: ' + e.message, 'error');
                    return;
                }
            }

            try {
                const resp = await fetch(`${API.presidio}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: textToAnalyze, language: 'fr' })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    const results = document.getElementById('piiResults');
                    const list = document.getElementById('piiResultsList');

                    if (data.detections && data.detections.length > 0) {
                        // CHECK ROLE FOR MASKING
                        const userRole = localStorage.getItem('userRole');
                        const isLabeler = userRole === 'labeler';

                        list.innerHTML = data.detections.map(d => {
                            // Apply masking if Labeler
                            let displayValue = d.value;
                            if (isLabeler) {
                                // Map specific entities to friendly tokens if needed, or just use uppercase type
                                if (d.entity_type.includes('PHONE')) displayValue = '[PHONE]';
                                else if (d.entity_type.includes('CIN')) displayValue = '[CIN]';
                                else if (d.entity_type.includes('IBAN')) displayValue = '[IBAN]';
                                else if (d.entity_type.includes('MAIL')) displayValue = '[EMAIL]';
                                else displayValue = `[${d.entity_type.toUpperCase()}]`;
                            }

                            return `
                            <div style="display: flex; justify-content: space-between; padding: var(--space-md); border-bottom: 1px solid var(--border-secondary);">
                                <div>
                                    <span class="badge badge-warning">${d.entity_type}</span>
                                    <code style="margin-left: var(--space-sm);">${displayValue}</code>
                                </div>
                                <span style="color: var(--text-tertiary);">${Math.round(d.score * 100)}% confidence</span>
                            </div>
                        `}).join('');
                        results.style.display = 'block';
                        showToast(`Found ${data.count} PII entities`, 'success');
                    } else {
                        list.innerHTML = '<p style="text-align: center; padding: var(--space-lg); color: var(--text-tertiary);">No PII detected</p>';
                        results.style.display = 'block';
                    }
                }
            } catch (e) {
                showToast('PII detection failed', 'error');
            }
        };

        // ==========================================
        // LOGOUT FUNCTION
        // ==========================================
        window.logout = function() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
        };

        // ==========================================
        //  REAL TASK MANAGEMENT LOGIC (SCENARIO 3)
        // ==========================================

        async function loadAnnotationTasks() {
            const userRole = localStorage.getItem('userRole') || 'labeler';
            const username = localStorage.getItem('username') || 'user'; // Assuming username stored
            const container = document.getElementById('taskQueueList');
            if (!container) return;

            // 1. Determine Logic based on Role
            // Admin: See unassigned tasks -> Assign
            // Steward: See unassigned tasks -> Assign (to Annotator/Labeler)
            // Annotator/Labeler: See MY assigned tasks
            
            let url = '';
            let isAssigner = false;

            if (['admin', 'steward'].includes(userRole)) {
                // Fetch unassigned pending tasks
                url = `${API.annotation}/tasks?status=pending`; 
                isAssigner = true;
            } else {
                // Fetch my assigned tasks
                // DEMO FIX: Force username to match role if it's one of our standard demo roles
                // This ensures that if you log in as "Labeler" (cap) but Admin assigned to "labeler" (lower), it still works.
                let queryUser = username;
                if(['labeler', 'annotator'].includes(userRole)) {
                    queryUser = userRole; 
                }
                url = `${API.annotation}/tasks?status=assigned&user_id=${queryUser}`;
            }

            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Failed to fetch tasks');
                
                const data = await resp.json();
                const tasks = data.tasks || [];

                if (tasks.length === 0) {
                    container.innerHTML = `
                        <p style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl);">
                            ${isAssigner ? 'No pending tasks to assign.' : 'No tasks assigned to you. Good job!'}
                        </p>
                    `;
                    // If Admin/Steward and empty, maybe offer to create demo tasks?
                    if(isAssigner) {
                         container.innerHTML += `
                            <div style="text-align: center; margin-top: -1rem; padding-bottom: 1rem;">
                                <button class="btn btn-secondary" onclick="createDemoTasks()">+ Generate Demo Tasks</button>
                            </div>
                         `;
                    }
                    return;
                }

                container.innerHTML = tasks.map(t => {
                    let actionHtml = '';
                    
                    if (isAssigner) {
                        // ASSIGNMENT UI
                        // Filter users based on Assignee Role restrictions can be done here or just show generic
                        actionHtml = `
                            <select class="form-input" style="width: auto; padding: 0.25rem; font-size: 0.875rem;" 
                                onchange="assignTask('${t.id}', this.value)">
                                <option value="">Assign to...</option>
                                <option value="labeler">Labeler</option>
                                <option value="annotator">Annotator</option>
                                <option value="steward">Steward</option>
                            </select>
                        `;
                    } else {
                        // EXECUTION UI
                        actionHtml = `<button class="btn btn-primary" onclick="startTask('${t.id}')">Start</button>`;
                    }

                    return `
                    <div class="task-item" style="padding: var(--space-md); border-bottom: 1px solid var(--border-primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span class="badge badge-primary">${t.annotation_type || 'Validation'}</span>
                                <span style="margin-left: var(--space-sm); font-weight: 500;">Dataset: ${t.dataset_id || 'Unknown'} (Row ${t.row_index})</span>
                            </div>
                            <div style="display: flex; gap: var(--space-sm);">
                                ${actionHtml}
                            </div>
                        </div>
                        <p style="color: var(--text-tertiary); margin-top: var(--space-xs); font-size: 0.875rem;">
                            Priority: <span style="text-transform: capitalize; color: ${t.priority === 'high' ? 'var(--danger)' : 'inherit'}">${t.priority}</span> 
                            | Created: ${new Date(t.created_at).toLocaleTimeString()}
                        </p>
                    </div>
                `}).join('');

                // Update counters
                if(!isAssigner) {
                    if(document.getElementById('myPendingTasks')) document.getElementById('myPendingTasks').textContent = tasks.length;
                    if(document.getElementById('statTasks')) document.getElementById('statTasks').textContent = tasks.length; // Update Dashboard Stat
                }

            } catch (e) {
                console.error("Load tasks error:", e);
                container.innerHTML = `<p style="color: var(--danger); text-align: center;">Error loading tasks</p>`;
            }
        }

        async function createDemoTasks() {
            // Helper to generate tasks if none exist
            try {
                await fetch(`${API.annotation}/tasks`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        dataset_id: 'demo_dataset_' + Date.now(),
                        annotation_type: 'pii_validation',
                        priority: 'medium',
                        row_indices: [1, 2, 3, 4, 5]
                    })
                });
                showToast("Generated 5 demo tasks", "success");
                loadAnnotationTasks();
            } catch(e) { console.error(e); }
        }

        async function assignTask(taskId, userId) {
            if(!userId) return;
            try {
                const resp = await fetch(`${API.annotation}/assign/${taskId}?user_id=${userId}`, { // POST /assign/{id}?user_id=...
                    method: 'POST' 
                });
                if(resp.ok) {
                    showToast(`Task assigned to ${userId}`, 'success');
                    loadAnnotationTasks(); // Refresh list
                }
            } catch(e) {
                showToast("Assignment failed", "error");
            }
        }

        async function startTask(taskId) {
            const username = localStorage.getItem('username') || 'labeler';
            try {
                // 1. Mark in progress
                await fetch(`${API.annotation}/tasks/${taskId}/start?user_id=${username}`, { method: 'POST' });
                
                // 2. Load Task Detail View (Simulated here by populating "Active Task")
                // In full app, we fetches task details: GET /tasks/{id}
                document.getElementById('taskQueueList').style.display = 'none';
                const activeArea = document.getElementById('activeTaskArea');
                activeArea.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                         <h4>Task In Progress</h4>
                         <p>Validating PII for Row...</p>
                         <div style="margin: 2rem 0;">
                            <!-- Mock Data Display -->
                            <code style="background: #1a1f2e; padding: 1rem; display: block; border-radius: 8px;">
                                { "phone": "+212 600...", "cin": "AB123..." }
                            </code>
                         </div>
                         <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-success" onclick="completeTask('${taskId}')">Confirm Valid</button>
                            <button class="btn btn-danger" onclick="completeTask('${taskId}')">Reject</button>
                            <button class="btn btn-secondary" onclick="cancelTask()">Cancel</button>
                         </div>
                    </div>
                `;
            } catch(e) {
                showToast("Could not start task", "error");
            }
        }

        function cancelTask() {
             document.getElementById('taskQueueList').style.display = 'block';
             document.getElementById('activeTaskArea').innerHTML = `
                 <p style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl);">
                    Select a task from your queue to start validation.
                </p>`;
        }

        async function completeTask(taskId) {
             const username = localStorage.getItem('username') || 'labeler';
             // 1. Submit
             try {
                 await fetch(`${API.annotation}/tasks/${taskId}/submit`, {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({
                         annotations: [{field: 'all', is_valid: true}], // Simple submit
                         time_spent_seconds: 30 // Mock time
                     })
                 });
                 showToast("Task Completed!", "success");
                 
                 // 2. Refresh Stats
                 loadUserStats();

                 // 3. Reset View
                 cancelTask();
                 loadAnnotationTasks();

             } catch(e) { showToast("Submission failed", "error"); }
        }

        async function loadUserStats() {
            const userRole = localStorage.getItem('userRole');
            // Only load for workers
            if (['admin', 'steward'].includes(userRole)) return; 

            const username = localStorage.getItem('username') || 'labeler';
            try {
                const resp = await fetch(`${API.annotation}/users/${username}/stats`);
                if(resp.ok) {
                    const stats = await resp.json();
                    
                    document.getElementById('myTasksCompleted').textContent = stats.completed;
                    document.getElementById('myAccuracy').textContent = `${stats.accuracy}%`;
                    document.getElementById('myAvgTime').textContent = `${stats.avg_time}s`;
                    document.getElementById('myKappaScore').textContent = stats.kappa;
                    
                    // Update progress bar
                    document.getElementById('accuracyProgress').style.width = `${stats.accuracy}%`;
                }
            } catch(e) { console.error("Stats load error", e); }
        }

        function checkDashboardAccess() {
            const role = localStorage.getItem('userRole') || 'labeler';
            
            // Default show all
            ['action-upload', 'action-cleaning', 'action-quality', 'action-pii'].forEach(id => {
                 const el = document.getElementById(id);
                 if(el) el.style.display = 'flex';
            });

            // Rules
            // Labeler: No Cleaning, No Quality
            if(role === 'labeler') {
                 const cCard = document.getElementById('action-cleaning');
                 if(cCard) cCard.style.display = 'none';
                 const qCard = document.getElementById('action-quality');
                 if(qCard) qCard.style.display = 'none';
            }
            
            // Annotator: No Quality
            if(role === 'annotator') {
                 const qCard = document.getElementById('action-quality');
                 if(qCard) qCard.style.display = 'none';
            }
        }

        // ==========================================
        //  ANNOTATOR WORKFLOW LOGIC (SCENARIO 3)
        // ==========================================

        const MOCK_CLASSIFICATIONS = [
            { id: 101, field: 'phone_number', value: '0612345678', label: 'PHONE_MA', confidence: 0.95 },
            { id: 102, field: 'identity_card', value: 'AB123456', label: 'CIN', confidence: 0.92 },
            { id: 103, field: 'description', value: 'Contact contact@example.com for info', label: 'EMAIL', confidence: 0.88 },
            { id: 104, field: 'salary', value: '15000 MAD', label: 'SALARY', confidence: 0.65 } // Low confidence, might need flag
        ];

        function loadClassifications() {
            const table = document.querySelector('#classificationsTable table tbody');
            if(!table) {
               const existingTbody = document.querySelector('#classificationsTable table tbody');
               if(existingTbody) existingTbody.innerHTMl = '';
            } else {
                table.innerHTML = '';
            }
            
            const tbody = document.querySelector('#classificationsTable table tbody') || document.createElement('tbody');
            if(!document.querySelector('#classificationsTable table tbody')) {
                 const tbl = document.querySelector('#classificationsTable table');
                 if(tbl) tbl.appendChild(tbody);
            }

            // REAL DATA SIMULATION: Check if we have detected entities from upload
            // In a real app, this comes from GET /classifications?status=pending
            // Here we check if the user just ran "PII Detection" on their uploaded file
            let displayItems = [...MOCK_CLASSIFICATIONS];
            
            // Try to pull "Recent Detections" from local storage if available (simulated backend persistence)
            const recentDetections = JSON.parse(localStorage.getItem('demo_recent_detections') || '[]');
            if(recentDetections.length > 0) {
                 displayItems = recentDetections.map((d, i) => ({
                     id: 1000 + i,
                     field: 'detected_entity',
                     value: d.text || d.value, // Handle different formats
                     label: d.type || d.entity_type,
                     confidence: d.score || 0.9
                 }));
            }

            displayItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.id = `row-class-${item.id}`;
                tr.innerHTML = `
                    <td>${item.field}</td>
                    <td><code class="mask-hidden">${item.value}</code></td>
                    <td><span class="badge badge-primary">${item.label}</span></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="progress" style="width: 60px; height: 6px;">
                                <div class="progress-bar" style="width: ${item.confidence * 100}%"></div>
                            </div>
                            <span>${Math.round(item.confidence * 100)}%</span>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-success" style="padding: 4px 8px; margin-right: 4px;" onclick="validateClassification(${item.id})" title="Validate">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                        <button class="btn btn-danger" style="padding: 4px 8px;" onclick="flagClassification(${item.id})" title="Flag False Positive">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            const counter = document.getElementById('pendingValidations');
            if(counter) counter.textContent = displayItems.length;
        }

        function validateClassification(id) {
            const row = document.getElementById(`row-class-${id}`);
            if(row) {
                // Visual feedback
                row.style.opacity = '0.5';
                setTimeout(() => {
                    row.innerHTML = `<td colspan="5" style="text-align: center; color: var(--success);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: text-bottom;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Validated
                    </td>`;
                    updateStats('validatedToday', 1);
                    updateStats('pendingValidations', -1);
                    showToast("Classification Validated", "success");
                    // In real app: POST /classifications/{id}/validate
                }, 500);
            }
        }

        function flagClassification(id) {
            const row = document.getElementById(`row-class-${id}`);
            if(row) {
               // Prompt for reason (simple for demo)
               const reason = prompt("Reason for flagging (e.g., Not PII, Wrong Label):", "False Positive");
               if(reason) {
                   row.style.opacity = '0.5';
                   setTimeout(() => {
                        row.innerHTML = `<td colspan="5" style="text-align: center; color: var(--warning);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: text-bottom;"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
                            Flagged for Review
                        </td>`;
                        updateStats('pendingValidations', -1);
                        showToast("Flagged for Steward Review", "warning");
                        // In real app: POST /classifications/{id}/flag
                   }, 500);
               }
            }
        }
        
        // Helper to update displayed stats
        function updateStats(id, delta) {
            const el = document.getElementById(id);
            if(el) {
                let val = parseInt(el.textContent.replace(/[^0-9]/g, '')) || 0;
                val += delta;
                el.textContent = val + (id.includes('Rate') ? '%' : '');
            }
        }

        // ==========================================
        //  CORRECTIONS WORKFLOW LOGIC (SCENARIO 3.2)
        // ==========================================
        const MOCK_CORRECTIONS = [
            { id: 201, dataset: 'customers_2024.csv', row: 45, field: 'email', error: 'Invalid Format', value: 'john.doe@gmail_com', status: 'pending' },
            { id: 202, dataset: 'customers_2024.csv', row: 12, field: 'phone', error: 'Too Short', value: '061234', status: 'pending' }
        ];

        function loadCorrections() {
             const container = document.querySelector('#view-corrections .card');
             if(!container) return;
             
             // PERSISTENCE: Get approvals from storage to check status
             const approvals = JSON.parse(localStorage.getItem('demo_approvals') || '[]');
             const approvalIds = approvals.map(a => a.id);

             // Merge State
             const displayCorrections = MOCK_CORRECTIONS.map(c => {
                 if(approvalIds.includes(c.id)) return { ...c, status: 'approval_pending' };
                 return c;
             });

             // Build Table
             let html = `
                <div class="card-header"><h4 class="card-title">Pending Corrections</h4></div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Dataset (Row)</th>
                                <th>Field</th>
                                <th>Error</th>
                                <th>Current Value</th>
                                <th>Correction</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
             `;
             
             if(displayCorrections.length === 0) {
                 container.innerHTML = `<p style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl);">No corrections pending.</p>`;
                 return;
             }

             displayCorrections.forEach(item => {
                 if(item.status === 'pending') {
                     html += `
                        <tr id="row-corr-${item.id}">
                            <td>${item.dataset} (${item.row})</td>
                            <td>${item.field}</td>
                            <td><span class="badge badge-danger">${item.error}</span></td>
                            <td><code class="mask-hidden">${item.value}</code></td>
                            <td>
                                <input type="text" class="form-input" id="input-corr-${item.id}" placeholder="Enter valid value..." style="padding: 4px 8px; font-size: 0.9em;">
                            </td>
                            <td>
                                <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.85em;" onclick="submitCorrection(${item.id})">Submit</button>
                            </td>
                        </tr>
                     `;
                 } else if (item.status === 'approval_pending') {
                      html += `
                        <tr id="row-corr-${item.id}" style="opacity: 0.7; background: rgba(var(--warning-rgb), 0.05);">
                            <td>${item.dataset} (${item.row})</td>
                            <td>${item.field}</td>
                            <td><span class="badge badge-warning">Reviewing</span></td>
                            <td><code class="mask-hidden">${item.value}</code></td>
                            <td colspan="2" style="text-align: center; font-style: italic; color: var(--warning);">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                Pending Steward Approval
                            </td>
                        </tr>
                     `;
                 }
             });
             
             html += `</tbody></table></div>`;
             container.innerHTML = html;
        }

        function submitCorrection(id) {
            const input = document.getElementById(`input-corr-${id}`);
            const row = document.getElementById(`row-corr-${id}`);
            
            if(!input || !input.value) {
                showToast("Please enter a correction value", "warning");
                return;
            }
            
            // Logic
            // In real app: POST /corrections/{id} -> status: approval_pending
            const item = MOCK_CORRECTIONS.find(i => i.id === id);
            if(item) {
                item.status = 'approval_pending';
                item.newValue = input.value;
                
                // DATA PERSISTENCE FOR STEWARD
                try {
                    const approvals = JSON.parse(localStorage.getItem('demo_approvals') || '[]');
                    const payload = { ...item, submittedAt: new Date().toISOString(), submittedBy: localStorage.getItem('username') };
                    approvals.push(payload);
                    localStorage.setItem('demo_approvals', JSON.stringify(approvals));
                    console.log("[DEBUG] User submitted correction. Saved to demo_approvals:", approvals);
                } catch (e) {
                    console.error("[DEBUG] Persistence failed:", e);
                    showToast("Error saving data: " + e.message, "error");
                }

                // UI Update
                row.innerHTML = `
                    <td>${item.dataset} (${item.row})</td>
                    <td>${item.field}</td>
                    <td><span class="badge badge-warning">Reviewing</span></td>
                    <td><code class="mask-hidden">${item.value}</code></td>
                    <td colspan="2" style="text-align: center; color: var(--warning); font-weight: 500;">
                        Pending Approval <br><small>(See Steward Console)</small>
                    </td>
                `;
                row.style.background = 'rgba(255, 170, 0, 0.05)';
                showToast("Correction Saved! Wait for Steward Approval.", "success");
            }
        }

        // ==========================================
        //  STEWARD APPROVAL FLOW (SCENARIO 3.x)
        // ==========================================
        function loadApprovals() {
            // Find container in View-Approvals
            const container = document.getElementById('approvalsList');
            if(!container) return;
            
            const approvals = JSON.parse(localStorage.getItem('demo_approvals') || '[]');
            
            // Pending Counter
            const pCount = document.getElementById('pendingCorrections');
            if(pCount) pCount.textContent = approvals.length;

             if(approvals.length === 0) {
                 container.innerHTML = `<p style="color: var(--text-tertiary); text-align: center; padding: var(--space-xl);">No items pending approval.</p>`;
                 return;
             }
             
             let html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Sub. By</th>
                                <th>Field</th>
                                <th>Original</th>
                                <th>Suggested Correction</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
             `;
             
             approvals.forEach((item, idx) => {
                  html += `
                    <tr id="row-appr-${idx}">
                        <td>${item.submittedBy || 'Annotator'}</td>
                        <td>${item.field}</td>
                        <td><code class="mask-hidden">${item.value}</code></td>
                        <td style="color: var(--success); font-weight: bold;">${item.newValue}</td>
                         <td>
                            <button class="btn btn-success" style="padding: 4px 8px; margin-right: 4px;" onclick="approveCorrection(${idx})" title="Approve">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </button>
                            <button class="btn btn-danger" style="padding: 4px 8px;" onclick="rejectCorrection(${idx})" title="Reject">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </td>
                    </tr>
                  `;
             });
             html += `</tbody></table></div>`;
             container.innerHTML = html;
        }

        function approveCorrection(idx) {
            // Update storage
            const approvals = JSON.parse(localStorage.getItem('demo_approvals') || '[]');
            if(approvals[idx]) {
                approvals.splice(idx, 1);
                localStorage.setItem('demo_approvals', JSON.stringify(approvals));
                loadApprovals(); // Refresh
                showToast("Correction Approved & Applied", "success");
            }
        }
        function rejectCorrection(idx) {
             const approvals = JSON.parse(localStorage.getItem('demo_approvals') || '[]');
             if(approvals[idx]) {
                approvals.splice(idx, 1);
                localStorage.setItem('demo_approvals', JSON.stringify(approvals));
                loadApprovals(); // Refresh
                showToast("Correction Rejected", "info");
             }
        }

        // ==========================================
        //  SIDEBAR TOGGLE
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
            // Save state
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }

        // Initialize sidebar state
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            document.querySelector('.sidebar').classList.add('collapsed');
        }

        // ==========================================
        //  INIT
        // ==========================================
        checkServices();
        updateMaskPreview();
        checkDashboardAccess();

        loadAnnotationTasks(); // Load tasks on init to update dashboard stats
        
        function updateDatasetLabels() {
            const fname = localStorage.getItem('currentFilename');
            const label = fname ? `Current: ${fname}` : 'Current Uploaded File (None)';
            
            // Update dropdowns
            const qSelect = document.getElementById('qualityDatasetSelect');
            if(qSelect) {
                 const opt = qSelect.querySelector('option[value="current"]');
                 if(opt) opt.textContent = label;
            }
            
            const mSelect = document.getElementById('maskDatasetSelect');
            if(mSelect) {
                 const opt = mSelect.querySelector('option[value="current"]');
                 if(opt) opt.textContent = label;
            }
        }
        updateDatasetLabels(); // Run on load
        
        // ==========================================
        //  SAFE LOGOUT (PRESERVES DEMO DATA)
        // ==========================================
        function safeLogout() {
            // Only clear AUTH data
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('userRole');
            
            // DO NOT CLEAR demo_approvals
            console.log("[DEBUG] Safe logout executed. Demo data preserved.");
            window.location.href = 'login.html';
        }

        // HOOK INTO NAVIGATION TO RELOAD DATA
        // Simple polling or hook on view change could work. 
        // For now, let's just call it initially and when switching views.
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const view = item.dataset.view;
                if(view === 'tasks') loadAnnotationTasks();
                if(view === 'user-stats') loadUserStats();
                if(view === 'classification-validation') loadClassifications();
                if(view === 'corrections') loadCorrections();
                if(view === 'approvals') loadApprovals();
            });
        });
    </script>
</body>

</html>